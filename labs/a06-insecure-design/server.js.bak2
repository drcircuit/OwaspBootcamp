const express = require('express');
const app = express();
const PORT = process.env.PORT || 3006;

app.use(express.json());

// State for Lab 1: Rate Limiting vulnerability
let lab1AttemptCount = 0;
const VALID_ACCOUNT_PIN = '1035';

// State for Lab 2: Logic Flaw vulnerability
const TRANSFER_TYPES = {
  'checking': { fee: 0, limit: 10000 },
  'savings': { fee: 0, limit: 5000 },
  'external': { fee: 2.50, limit: 2500 },
  'wire': { fee: 25.00, limit: 50000 }
};

// State for Lab 3: Race Condition vulnerability
let lab3Balance = 1000.00;
let lab3Processing = false;

// SecureBank Online Banking theme styles
const styles = `
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
      color: #1e293b;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 15px;
      padding: 40px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }
    h1 {
      color: #1e40af;
      margin-bottom: 10px;
      font-size: 2.8em;
      text-align: center;
      font-weight: 800;
    }
    h2 {
      color: #2563eb;
      margin-top: 30px;
      margin-bottom: 15px;
      border-bottom: 3px solid #F7931E;
      padding-bottom: 10px;
      font-weight: 700;
    }
    h3 {
      color: #2B2D42;
      margin-top: 20px;
      margin-bottom: 10px;
      font-weight: 600;
    }
    p, li {
      line-height: 1.8;
      margin-bottom: 10px;
      color: #2B2D42;
    }
    .nav-links {
      display: flex;
      gap: 20px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .nav-links a {
      color: #FFF;
      text-decoration: none;
      padding: 12px 24px;
      border: 2px solid #FF6B35;
      border-radius: 8px;
      transition: all 0.3s;
      background: #FF6B35;
      font-weight: 600;
    }
    .nav-links a:hover {
      background: #C1121F;
      border-color: #C1121F;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(193, 18, 31, 0.3);
    }
    .challenge {
      background: linear-gradient(135deg, #FFF8F0 0%, #FFE5D0 100%);
      border: 2px solid #FF6B35;
      padding: 20px;
      margin: 20px 0;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.2);
    }
    .challenge h3 {
      margin-top: 0;
      color: #C1121F;
      font-size: 1.5em;
    }
    .difficulty {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      margin-left: 10px;
      font-size: 0.9em;
    }
    .easy { background: #10B981; color: #FFF; }
    .medium { background: #F7931E; color: #FFF; }
    .hard { background: #C1121F; color: #FFF; }
    .example { background: #3B82F6; color: #FFF; }
    .section {
      background: #FFF;
      border: 2px solid #F7931E;
      padding: 20px;
      margin: 20px 0;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .good {
      background: #D1FAE5;
      border-left: 4px solid #10B981;
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
    }
    .bad {
      background: #FEE2E2;
      border-left: 4px solid #EF4444;
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
    }
    .lab-info {
      background: #FEF3C7;
      border-left: 4px solid #F59E0B;
      padding: 15px;
      margin: 20px 0;
      border-radius: 5px;
    }
    .hint-box {
      background: #DBEAFE;
      border-left: 4px solid #3B82F6;
      padding: 15px;
      margin: 20px 0;
      border-radius: 5px;
    }
    .endpoint {
      background: #F3F4F6;
      border: 2px solid #6B7280;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      color: #1F2937;
      font-family: 'Courier New', monospace;
    }
    pre {
      background: #1F2937;
      color: #10B981;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #374151;
      overflow-x: auto;
      margin: 10px 0;
    }
    code {
      background: #FEE2E2;
      color: #B91C1C;
      padding: 2px 8px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }
    ul {
      margin-left: 20px;
      margin-top: 10px;
    }
    a {
      color: #FF6B35;
      text-decoration: none;
      font-weight: 600;
      border-bottom: 2px solid transparent;
      transition: border-bottom 0.2s;
    }
    a:hover {
      border-bottom: 2px solid #FF6B35;
    }
  </style>
`;

// Home page
app.get('/', (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>SecureBank Online üè¶ - Banking Portal</title>
      ${styles}
    </head>
    <body>
      <div class="container">
        <h1>ÔøΩ SECUREBANK ONLINE</h1>
        <p style="text-align: center; font-size: 1.2em; color: #F7931E; margin-bottom: 30px;">
          <strong>Pre-Order Your Favorite Tacos!</strong><br>
          Fast, fresh, and always delicious Mexican street food
        </p>
        
        <div class="challenge">
          <h3>üìö Tutorial - How Our System Works <span class="difficulty example">START HERE</span></h3>
          <p>Learn how SecureBank handles transactions, transfers, and account security. See examples of our security measures in action.</p>
          <p><a href="/example">‚Üí View Tutorial</a></p>
        </div>

        <div class="challenge">
          <h3>üåÆ Lab 1 - Order System <span class="difficulty easy">EASY</span></h3>
          <p><strong>Mission:</strong> Test our high-speed ordering system</p>
          <p><strong>Description:</strong> During lunch rush, customers can rapid-fire orders. See if our system handles the volume!</p>
          <p><strong>Your Task:</strong> Place multiple orders quickly</p>
          <p><a href="/lab1">‚Üí Start Lab 1</a></p>
        </div>

        <div class="challenge">
          <h3>üéüÔ∏è Lab 2 - Discount Codes <span class="difficulty medium">MEDIUM</span></h3>
          <p><strong>Mission:</strong> Maximize your savings with promo codes</p>
          <p><strong>Description:</strong> We offer various discount codes. Stack them wisely to get the best deal!</p>
          <p><strong>Your Task:</strong> Find the best combination of discount codes</p>
          <p><a href="/lab2">‚Üí Start Lab 2</a></p>
        </div>

        <div class="challenge">
          <h3>üí∞ Lab 3 - Account Balance <span class="difficulty hard">HARD</span></h3>
          <p><strong>Mission:</strong> Test our loyalty rewards system</p>
          <p><strong>Description:</strong> Use your $50 account balance to place orders. Our system processes payments in real-time.</p>
          <p><strong>Your Task:</strong> Make the most of your loyalty balance</p>
          <p><a href="/lab3">‚Üí Start Lab 3</a></p>
        </div>

        <div class="section">
          <h2>üåÆ Our Menu</h2>
          <ul style="font-size: 1.1em;">
            <li><strong>Carne Asada</strong> - Grilled steak with cilantro & onions - $3.50</li>
            <li><strong>Al Pastor</strong> - Marinated pork with pineapple - $3.75</li>
            <li><strong>Pollo Asado</strong> - Grilled chicken with lime - $3.25</li>
            <li><strong>Vegetarian</strong> - Black beans, peppers & guacamole - $3.00</li>
          </ul>
        </div>

        <p style="text-align: center; margin-top: 40px;">
          <a href="/">‚Üê Back to Main Portal</a>
        </p>
      </div>
    </body>
    </html>
  `);
});

// Example page - Interactive Tutorial
// Example - Account Security Demo with DevTools Discovery
app.get('/example', (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>SecureBank Account Dashboard</title>
      ${styles}
    </head>
    <body>
      <div class="container">
        <h1>üè¶ SECUREBANK ACCOUNT OVERVIEW</h1>
        <div class="nav-links">
          <a href="/">üè† Home</a>
        </div>

        <div class="challenge" style="margin: 30px 0;">
          <h2>Welcome to Your Account Dashboard</h2>
          <p>View your account details, recent transactions, and rewards status.</p>
          
          <div id="account-info" style="background: white; padding: 25px; border-radius: 10px; margin-top: 20px;">
            <p style="color: #667eea; font-size: 1.1em;">Loading account information...</p>
          </div>
          
          <div class="hint-box" style="margin-top: 30px;">
            <strong>üí° Discovery Tip:</strong> Use browser DevTools (F12 ‚Üí Network tab) to see how this dashboard loads your account data.
          </div>
        </div>
      </div>

      <script>
        window.addEventListener('DOMContentLoaded', async () => {
          try {
            await fetch('/api/example/account');
            await fetch('/api/example/transactions');
            await fetch('/api/example/rewards');
            const debugResp = await fetch('/api/example/debug');
            const debugData = await debugResp.json();
            
            const infoDiv = document.getElementById('account-info');
            if (debugData.flag) {
              infoDiv.innerHTML = \`
                <div style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                  <h3>üéØ Flag Found!</h3>
                  <p style="font-size: 1.2em; font-weight: bold; margin-top: 10px;">\${debugData.flag}</p>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                  <div style="background: #e3f2fd; padding: 20px; border-radius: 10px;">
                    <h4 style="color: #1976d2;">Account Balance</h4>
                    <p style="font-size: 1.5em; color: #1976d2; font-weight: bold;">$\${debugData.account.balance.toFixed(2)}</p>
                  </div>
                  <div style="background: #f3e5f5; padding: 20px; border-radius: 10px;">
                    <h4 style="color: #7b1fa2;">Rewards Points</h4>
                    <p style="font-size: 1.5em; color: #7b1fa2; font-weight: bold;">\${debugData.account.rewards_points}</p>
                  </div>
                  <div style="background: #e8f5e9; padding: 20px; border-radius: 10px;">
                    <h4 style="color: #388e3c;">Account Status</h4>
                    <p style="font-size: 1.5em; color: #388e3c; font-weight: bold;">\${debugData.account.status}</p>
                  </div>
                </div>
              \`;
            }
          } catch (error) {
            document.getElementById('account-info').innerHTML = 
              '<p style="color: red;">Error loading account data</p>';
          }
        });
      </script>
    </body>
    </html>
  `);
});

// Example API endpoints
app.get('/api/example/account', (req, res) => {
  res.json({
    success: true,
    message: 'Part 1/4: Basic account endpoint',
    hint: 'Try /api/example/transactions'
  });
});

app.get('/api/example/transactions', (req, res) => {
  res.json({
    success: true,
    message: 'Part 2/4: Transaction history endpoint',
    hint: 'Check /api/example/rewards',
    recent_count: 5
  });
});

app.get('/api/example/rewards', (req, res) => {
  res.json({
    success: true,
    message: 'Part 3/4: Rewards endpoint',
    hint: 'There might be a debug endpoint',
    points: 1250
  });
});

app.get('/api/example/debug', (req, res) => {
  res.json({
    success: true,
    message: 'Part 4/4: Debug endpoint discovered!',
    flag: 'NSA{D3S1GN_FL4WS_F0UND}',
    account: {
      id: 'ACC-12345',
      balance: 1000.00,
      rewards_points: 1250,
      status: 'Active'
    },
    available_endpoints: [
      '/api/verify-pin',
      '/api/checkout',
      '/api/withdraw'
    ]
  });
});

// Lab 1 - Rate Limiting Bypass (PIN Verification)
app.get('/lab1', (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>SecureBank PIN Verification</title>
      ${styles}
    </head>
    <body>
      <div class="container">
        <h1>üîê ACCOUNT PIN VERIFICATION</h1>
        <div class="nav-links">
          <a href="/">ÔøΩÔøΩ Home</a>
        </div>

        <div class="challenge" style="margin: 30px 0;">
          <h2>Verify Your Account PIN</h2>
          <p>Enter your 4-digit PIN to access your account. For security, your account will be locked after too many failed attempts.</p>
          
          <div style="background: white; padding: 30px; border-radius: 10px; max-width: 400px; margin: 30px auto;">
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #2B2D42;">Account ID:</label>
              <input type="text" id="account-id" value="ACC-12345" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #2B2D42;">PIN Code:</label>
              <input type="password" id="pin-code" placeholder="Enter 4-digit PIN" maxlength="4" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.5em; text-align: center; letter-spacing: 10px;">
            </div>
            
            <button onclick="verifyPin()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 600; cursor: pointer;">
              Verify PIN
            </button>
            
            <div id="attempt-counter" style="margin-top: 15px; text-align: center; color: #666; font-size: 0.9em;">
              Attempts: 0
            </div>
          </div>
          
          <div id="verification-result" style="margin-top: 30px;"></div>
          
          <div class="hint-box" style="margin-top: 30px;">
            <strong>üí° Discovery Tip:</strong> Use automation tools or scripts to test multiple PIN combinations. The PIN is a 4-digit number (0000-9999).<br>
            Try using curl, Python requests, or browser automation to test rapidly.
          </div>
        </div>
      </div>

      <script>
        let attemptCount = 0;
        
        async function verifyPin() {
          const accountId = document.getElementById('account-id').value;
          const pin = document.getElementById('pin-code').value;
          const resultDiv = document.getElementById('verification-result');
          
          if (!pin || pin.length !== 4) {
            resultDiv.innerHTML = '<div style="background: #ffebee; color: #c62828; padding: 15px; border-radius: 8px;">Please enter a 4-digit PIN</div>';
            return;
          }
          
          attemptCount++;
          document.getElementById('attempt-counter').textContent = \`Attempts: \${attemptCount}\`;
          
          try {
            const response = await fetch('/api/verify-pin', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ account_id: accountId, pin: pin })
            });
            
            const data = await response.json();
            
            if (data.flag) {
              resultDiv.innerHTML = \`
                <div style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color: white; padding: 25px; border-radius: 10px;">
                  <h3>üéØ Access Granted!</h3>
                  <p style="font-size: 1.3em; font-weight: bold; margin: 15px 0;">\${data.flag}</p>
                  <p>\${data.message}</p>
                  <p style="margin-top: 15px; font-size: 0.9em;">Total attempts: \${attemptCount}</p>
                </div>
              \`;
            } else {
              resultDiv.innerHTML = \`
                <div style="background: #ffebee; color: #c62828; padding: 20px; border-radius: 8px;">
                  <h4>‚ùå Access Denied</h4>
                  <p>\${data.message || 'Invalid PIN'}</p>
                </div>
              \`;
            }
          } catch (error) {
            resultDiv.innerHTML = '<div style="background: #ffebee; color: #c62828; padding: 15px; border-radius: 8px;">Connection error</div>';
          }
        }
        
        document.getElementById('pin-code').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') verifyPin();
        });
      </script>
    </body>
    </html>
  `);
});

// Lab 1 API - VULNERABLE: No rate limiting on PIN verification
app.post('/api/verify-pin', (req, res) => {
  const { account_id, pin } = req.body;
  
  if (!account_id || !pin) {
    return res.status(400).json({
      success: false,
      message: 'Missing account_id or pin'
    });
  }
  
  // VULNERABLE: No rate limiting, no account lockout, no delay between attempts
  // Allows unlimited brute force attempts on 4-digit PIN
  
  const VALID_PIN = '1035';
  
  if (pin === VALID_PIN) {
    return res.json({
      success: true,
      flag: 'NSA{N0_R4T3_L1M1T}',
      message: 'PIN verified successfully! The system had no rate limiting, allowing unlimited brute force attempts.',
      account_id: account_id,
      access_granted: true,
      vulnerability: 'No rate limiting allows attackers to try all 10,000 possible 4-digit PINs'
    });
  }
  
  res.status(401).json({
    success: false,
    message: 'Invalid PIN',
    hint: 'Try more combinations. There is no rate limiting preventing brute force attacks.'
  });
});

app.get('/lab2', (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Lab 2 - Discount Codes</title>
      ${styles}
      <style>
        .interactive-demo {
          background: #FFF3E0;
          padding: 20px;
          border-radius: 10px;
          margin: 15px 0;
          border-left: 3px solid #FF9800;
        }
        .demo-input {
          width: 100%;
          padding: 12px;
          border: 2px solid #FF6B35;
          border-radius: 8px;
          font-size: 1em;
          margin: 10px 0;
        }
        .demo-button {
          background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
          color: white;
          padding: 12px 24px;
          border: none;
          border-radius: 8px;
          font-weight: 600;
          cursor: pointer;
          font-size: 1em;
          margin: 5px;
        }
        .demo-button:hover {
          background: linear-gradient(135deg, #C1121F 0%, #FF6B35 100%);
        }
        .output-box {
          background: #f5f5f5;
          padding: 15px;
          border-radius: 8px;
          margin: 15px 0;
          font-family: 'Courier New', monospace;
          font-size: 0.9em;
          white-space: pre-wrap;
          word-wrap: break-word;
          max-height: 400px;
          overflow-y: auto;
          border: 1px solid #ddd;
        }
        .flag-reveal {
          background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
          color: white;
          padding: 20px;
          border-radius: 10px;
          margin: 15px 0;
          text-align: center;
          font-weight: bold;
          font-size: 1.2em;
          display: none;
        }
        .item-selector {
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
          margin: 10px 0;
        }
        .item-btn {
          padding: 10px 15px;
          border: 2px solid #FF6B35;
          background: white;
          border-radius: 8px;
          cursor: pointer;
          font-weight: 600;
          transition: all 0.3s;
        }
        .item-btn.selected {
          background: #FF6B35;
          color: white;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <h1>üéüÔ∏è LAB 2: PROMO CODE STACKING <span class="difficulty medium">MEDIUM</span></h1>
        <div class="nav-links">
          <a href="/">üè† Home</a>
          <a href="/example">üìö Tutorial</a>
        </div>

        <div class="lab-info">
          <h3>üéØ Benefit Application</h3>
          <p><strong>Scenario:</strong> Apply account benefits during signup</p>
          <p><strong>Service:</strong> Add benefit codes to reduce initial deposit</p>
        </div>

        <div class="section">
          <h2>üéüÔ∏è Account Benefits</h2>
          <p>SecureBank allows customers to apply multiple benefit codes at account creation. Add codes below to reduce your initial deposit requirement.</p>
        </div>

        <div class="section">
          <h2>üéüÔ∏è Available Codes</h2>
          <ul style="font-size: 1.1em;">
            <li><code>SAVE10</code> - 10% off</li>
            <li><code>WELCOME15</code> - 15% off</li>
            <li><code>FIRST5</code> - $5 off</li>
          </ul>
        </div>

        <div class="interactive-demo">
          <h3>Application System</h3>
          <p><strong>Step 1:</strong> Select your account type</p>
          <div class="item-selector">
            <button class="item-btn" onclick="toggleItem('checking')">üí∞ Checking ($100)</button>
            <button class="item-btn" onclick="toggleItem('savings')">üíé Savings ($250)</button>
            <button class="item-btn" onclick="toggleItem('investment')">üìà Investment ($500)</button>
          </div>
          
          <p style="margin-top: 15px;"><strong>Step 2:</strong> Enter benefit codes (comma-separated)</p>
          <input type="text" id="promo-codes" class="demo-input" placeholder="e.g., SAVE10" value="">
          
          <button onclick="checkout()" class="demo-button" style="width: 100%;">‚úÖ Apply Benefits</button>
          <div id="output" class="output-box"></div>
          <div id="flag" class="flag-reveal"></div>
        </div>

        <div style="text-align: center; margin-top: 40px;">
          <a href="/lab1">‚Üê Previous Lab</a> | <a href="/">Home</a> | <a href="/lab3">Next Lab ‚Üí</a>
        </div>
      </div>

      <script>
        let selectedItems = [];

        function toggleItem(item) {
          const btn = event.target;
          const index = selectedItems.indexOf(item);
          
          if (index > -1) {
            selectedItems.splice(index, 1);
            btn.classList.remove('selected');
          } else {
            selectedItems.push(item);
            btn.classList.add('selected');
          }
        }

        async function checkout() {
          const promoInput = document.getElementById('promo-codes').value;
          const promoCodes = promoInput.split(',').map(c => c.trim()).filter(c => c);
          const output = document.getElementById('output');
          const flagDiv = document.getElementById('flag');
          
          if (selectedItems.length === 0) {
            output.textContent = 'Please select at least one item!';
            return;
          }
          
          output.textContent = 'Processing checkout...';
          flagDiv.style.display = 'none';
          
          try {
            const response = await fetch('/api/lab2/checkout', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                items: selectedItems,
                promoCodes
              })
            });
            const data = await response.json();
            
            output.textContent = JSON.stringify(data, null, 2);
            
            if (data.flag) {
              flagDiv.innerHTML = 'üéâ FLAG CAPTURED!<br><br>' + data.flag + '<br><br>' + data.message;
              flagDiv.style.display = 'block';
            }
          } catch (error) {
            output.textContent = 'Error: ' + error.message;
          }
        }
      </script>
    </body>
    </html>
  `);
});

// Lab 2 API endpoint
app.post('/api/lab2/checkout', (req, res) => {
  const { items, promoCodes } = req.body;
  
  if (!items || items.length === 0) {
    return res.status(400).json({ error: 'No items in cart' });
  }
  
  // Calculate original total
  let total = 0;
  items.forEach(item => {
    total += MENU_ITEMS[item] || 0;
  });
  
  const originalTotal = total;
  let discountsApplied = [];
  
  // VULNERABLE: No check for duplicate promo codes!
  promoCodes.forEach(code => {
    if (code === 'TACO10') {
      total *= 0.9;
      discountsApplied.push('TACO10: 10% off');
    } else if (code === 'LUNCH15') {
      total *= 0.85;
      discountsApplied.push('LUNCH15: 15% off');
    } else if (code === 'FIRST5') {
      total -= 5;
      discountsApplied.push('FIRST5: $5 off');
    }
  });
  
  // Award flag if discount exceeds 50%
  if (total < originalTotal * 0.5) {
    return res.json({
      flag: 'NSA{L0G1C_FL4W_F0UND}',
      message: 'Business logic flaw exploited! Promo codes stacked for extreme discount.',
      vulnerability: 'No validation prevents duplicate promo codes from being applied',
      originalTotal: `$${originalTotal.toFixed(2)}`,
      finalTotal: `$${total.toFixed(2)}`,
      discountPercent: `${((1 - total/originalTotal) * 100).toFixed(1)}%`,
      discountsApplied,
      codesUsed: promoCodes.length
    });
  }
  
  res.json({
    originalTotal: `$${originalTotal.toFixed(2)}`,
    finalTotal: `$${total.toFixed(2)}`,
    discountPercent: `${((1 - total/originalTotal) * 100).toFixed(1)}%`,
    discountsApplied,
    message: 'Try stacking more codes to exceed 50% discount!',
    hint: 'Same code can be applied multiple times...'
  });
});

// Lab 3 page - Race Condition
app.get('/lab3', (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Lab 3 - Account Balance</title>
      ${styles}
      <style>
        .interactive-demo {
          background: #FFF3E0;
          padding: 20px;
          border-radius: 10px;
          margin: 15px 0;
          border-left: 3px solid #FF9800;
        }
        .demo-input {
          width: 100%;
          padding: 12px;
          border: 2px solid #FF6B35;
          border-radius: 8px;
          font-size: 1em;
          margin: 10px 0;
        }
        .demo-button {
          background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
          color: white;
          padding: 12px 24px;
          border: none;
          border-radius: 8px;
          font-weight: 600;
          cursor: pointer;
          font-size: 1em;
          margin: 5px;
        }
        .demo-button:hover {
          background: linear-gradient(135deg, #C1121F 0%, #FF6B35 100%);
        }
        .demo-button:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }
        .output-box {
          background: #f5f5f5;
          padding: 15px;
          border-radius: 8px;
          margin: 15px 0;
          font-family: 'Courier New', monospace;
          font-size: 0.9em;
          white-space: pre-wrap;
          word-wrap: break-word;
          max-height: 400px;
          overflow-y: auto;
          border: 1px solid #ddd;
        }
        .flag-reveal {
          background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
          color: white;
          padding: 20px;
          border-radius: 10px;
          margin: 15px 0;
          text-align: center;
          font-weight: bold;
          font-size: 1.2em;
          display: none;
        }
        .balance-display {
          background: #E8F5E9;
          padding: 20px;
          border-radius: 10px;
          margin: 15px 0;
          text-align: center;
          font-size: 1.5em;
          font-weight: bold;
          color: #2e7d32;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <h1>üí∞ LAB 3: RACE CONDITION <span class="difficulty hard">HARD</span></h1>
        <div class="nav-links">
          <a href="/">üè† Home</a>
          <a href="/example">üìö Tutorial</a>
        </div>

        <div class="lab-info">
          <h3>üéØ Transfer System</h3>
          <p><strong>Service:</strong> Transfer funds between accounts</p>
          <p><strong>Balance:</strong> $1000.00 available</p>
        </div>

        <div class="section">
          <h2>üí∞ Account Transfer</h2>
          <p>SecureBank allows customers to transfer funds to other accounts or external recipients using available balance.</p>
        </div>

        <div class="balance-display">
          Current Balance: <span id="balance-display">$1000.00</span>
        </div>

        <div class="section">
          <h2>üîß API Information</h2>
          <p><strong>Endpoint:</strong> <code>POST /api/transfer</code></p>
          <p><strong>Request Body:</strong></p>
          <pre>{
  "accountId": "acc_123",
  "amount": 250.00,
  "recipient": "External Account"
}</pre>
        </div>

        <div style="text-align: center; margin-top: 40px;">
          <a href="/">‚Üê Back to Home</a>
        </div>
      </div>
    </body>
    </html>
  `);
});

// API Endpoints

// Lab 1 API - Rate Limiting vulnerability
app.post('/api/order', (req, res) => {
  const { item, quantity } = req.body;
  const clientIp = req.ip || 'unknown';
  
  // Vulnerable: No rate limiting
  if (!orderAttempts[clientIp]) {
    orderAttempts[clientIp] = [];
  }
  
  orderAttempts[clientIp].push({ 
    item, 
    quantity, 
    timestamp: Date.now() 
  });
  
  // Check if user made many rapid orders
  const recentOrders = orderAttempts[clientIp].filter(
    order => Date.now() - order.timestamp < 10000
  );
  
  if (recentOrders.length > 20) {
    return res.json({
      success: true,
      orderId: Math.random().toString(36).substr(2, 9),
      item,
      quantity,
      totalOrders: recentOrders.length,
      flag: 'NSA{N0_R4T3_L1M1T}',
      message: 'üéâ Flag captured! You exploited the missing rate limit!',
      vulnerability: 'No rate limiting allows rapid-fire requests',
      secureAlternative: 'Implement sliding window rate limit (e.g., max 10 orders per minute)'
    });
  }
  
  res.json({
    success: true,
    orderId: Math.random().toString(36).substr(2, 9),
    item,
    quantity,
    totalOrders: recentOrders.length,
    hint: `${recentOrders.length}/20 rapid orders made`
  });
});

// Lab 2 API - Logic Flaw vulnerability
app.post('/api/apply-promo', (req, res) => {
  const { promoCodes, cartTotal } = req.body;
  
  // Vulnerable: Allows stacking of codes that shouldn't be combined
  let discountPercent = 0;
  const appliedCodes = [];
  
  // Available codes
  const validCodes = {
    'FIRST10': 10,    // First order discount
    'SAVE15': 15,     // General discount
    'LUNCH20': 20,    // Lunch special
    'VIP25': 25       // VIP members only
  };
  
  promoCodes.forEach(code => {
    if (validCodes[code]) {
      discountPercent += validCodes[code];
      appliedCodes.push(code);
      
      // Track usage for each session (vulnerable: no proper validation)
      if (!promoCodeUsage[code]) {
        promoCodeUsage[code] = 0;
      }
      promoCodeUsage[code]++;
    }
  });
  
  const discountAmount = (cartTotal * discountPercent) / 100;
  const finalTotal = Math.max(0, cartTotal - discountAmount);
  
  // Flag when discount exceeds 50%
  if (discountPercent >= 50) {
    return res.json({
      success: true,
      originalTotal: cartTotal,
      discountPercent,
      discountAmount,
      finalTotal,
      appliedCodes,
      flag: 'NSA{L0G1C_FL4W_F0UND}',
      message: 'üéâ Flag captured! You exploited the promo code stacking flaw!',
      vulnerability: 'Multiple discount codes can be stacked without validation',
      secureAlternative: 'Implement mutually exclusive discount categories'
    });
  }
  
  res.json({
    success: true,
    originalTotal: cartTotal,
    discountPercent,
    discountAmount,
    finalTotal,
    appliedCodes,
    hint: `${discountPercent}% discount applied. Try combining more codes!`
  });
});

// Lab 3 API - Race Condition vulnerability
app.post('/api/purchase', (req, res) => {
  const { customerId, amount, item } = req.body;
  
  // Vulnerable: No locking or transaction control
  const balance = accountBalances[customerId];
  
  if (balance === undefined) {
    return res.status(404).json({ 
      success: false, 
      message: 'Customer not found' 
    });
  }
  
  // Check balance before purchase (vulnerable to race condition)
  if (balance >= amount) {
    // Simulate processing delay that allows race condition
    setTimeout(() => {
      accountBalances[customerId] -= amount;
      
      orderHistory.push({
        customerId,
        item,
        amount,
        timestamp: new Date().toISOString(),
        balanceAfter: accountBalances[customerId]
      });
      
      // Check if customer went over their original balance
      const totalSpent = 50.00 - accountBalances[customerId];
      
      if (accountBalances[customerId] < 0 || totalSpent > 50.00) {
        return res.json({
          success: true,
          item,
          amount,
          newBalance: accountBalances[customerId],
          totalSpent,
          flag: 'NSA{R4C3_C0ND1T10N_3XPL01T3D}',
          message: 'üéâ Flag captured! You exploited the race condition!',
          vulnerability: 'Concurrent requests processed without locking',
          secureAlternative: 'Use database transactions with row-level locking'
        });
      }
      
      res.json({
        success: true,
        item,
        amount,
        newBalance: accountBalances[customerId],
        totalSpent,
        hint: 'Try sending multiple requests at the exact same time'
      });
    }, 10); // Small delay to make race condition easier to exploit
  } else {
    res.status(400).json({
      success: false,
      message: 'Insufficient balance',
      balance,
      required: amount
    });
  }
});

app.listen(PORT, '0.0.0.0', () => {
  console.log(`\x1b[32m
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   ÔøΩ SecureBank Online Banking             ‚ïë
‚ïë   Server running on port ${PORT}           ‚ïë
‚ïë                                            ‚ïë
‚ïë   Access the portal:                      ‚ïë
‚ïë   http://localhost:${PORT}                    ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
\x1b[0m`);
});
