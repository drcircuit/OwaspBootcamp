const express = require('express');
const app = express();
const PORT = process.env.PORT || 3005;

app.use(express.json());

const products = [
  { id: 1, name: 'Wireless Headphones Pro', price: 249.99, category: 'audio', stock: 45, sku: 'AUD-HP-001', rating: 4.5 },
  { id: 2, name: 'Smart Watch Series 5', price: 399.99, category: 'wearables', stock: 23, sku: 'WER-SW-005', rating: 4.7 },
  { id: 3, name: 'USB-C Charging Cable 6ft', price: 19.99, category: 'accessories', stock: 150, sku: 'ACC-CBL-006', rating: 4.2 },
  { id: 4, name: 'Laptop Stand Aluminum', price: 79.99, category: 'office', stock: 67, sku: 'OFF-STD-012', rating: 4.8 },
  { id: 5, name: '4K Webcam Ultra HD', price: 129.99, category: 'video', stock: 34, sku: 'VID-WC-008', rating: 4.6 },
  { id: 6, name: 'Mechanical Keyboard RGB', price: 159.99, category: 'peripherals', stock: 28, sku: 'PER-KB-015', rating: 4.9 },
  { id: 7, name: 'Portable SSD 1TB', price: 149.99, category: 'storage', stock: 56, sku: 'STR-SSD-020', rating: 4.7 },
  { id: 8, name: 'Wireless Mouse Ergonomic', price: 49.99, category: 'peripherals', stock: 89, sku: 'PER-MS-018', rating: 4.4 }
];

const customers = [
  { id: 1, email: 'admin@shoptech.com', password: 'ShopAdmin2024!', name: 'Emma Martinez', role: 'admin', credit_card: '**** **** **** 4521', rewards_points: 12500, member_since: '2020-01-15' },
  { id: 2, email: 'john.buyer@email.com', password: 'Tech123!', name: 'John Richardson', role: 'customer', credit_card: '**** **** **** 7834', rewards_points: 850, member_since: '2023-04-20' },
  { id: 3, email: 'sarah.tech@email.com', password: 'Gadget2024', name: 'Sarah Chen', role: 'customer', credit_card: '**** **** **** 2193', rewards_points: 2340, member_since: '2022-08-10' },
  { id: 4, email: 'mike.shopper@email.com', password: 'BuyStuff99', name: 'Mike Thompson', role: 'customer', credit_card: '**** **** **** 8901', rewards_points: 450, member_since: '2024-01-05' }
];

// Shared styles for ShopTech E-Commerce theme
const styles = `
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header {
      background: white;
      padding: 30px 40px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 30px;
      text-align: center;
    }
    h1 {
      color: #667eea;
      font-size: 2.5em;
      margin-bottom: 10px;
      font-weight: 700;
    }
    .subtitle { color: #764ba2; font-size: 1.2em; }
    .welcome-section {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }
    .welcome-section h2 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 2em;
    }
    .welcome-section p {
      color: #555;
      line-height: 1.8;
      font-size: 1.1em;
    }
    .nav-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }
    .card {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      transition: transform 0.2s, box-shadow 0.2s;
      text-decoration: none;
      color: inherit;
      display: block;
      border-left: 4px solid #667eea;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    }
    .card h3 { color: #667eea; margin-bottom: 15px; font-size: 1.4em; }
    .card p { color: #666; line-height: 1.6; margin-bottom: 15px; }
    .card-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.75em;
      font-weight: 600;
      text-transform: uppercase;
    }
    .badge-tutorial { background: #e3f2fd; color: #1976d2; }
    .badge-easy { background: #e8f5e9; color: #388e3c; }
    .badge-medium { background: #fff3e0; color: #f57c00; }
    .badge-hard { background: #ffebee; color: #d32f2f; }
    .tutorial-section {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 25px;
      border-left: 4px solid #ff6b9d;
    }
    .tutorial-section h2 {
      color: #ff6b9d;
      margin-bottom: 15px;
      font-size: 1.8em;
    }
    .tutorial-section p { color: #555; margin-bottom: 15px; line-height: 1.7; }
    .tutorial-box {
      background: #f1f8e9;
      padding: 20px;
      border-radius: 10px;
      margin: 15px 0;
      border-left: 3px solid #4caf50;
    }
    .interactive-demo {
      background: #fff3e0;
      padding: 20px;
      border-radius: 10px;
      margin: 15px 0;
      border-left: 3px solid #ff9800;
    }
    .demo-controls { margin: 15px 0; }
    .demo-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ff6b9d;
      border-radius: 8px;
      font-size: 1em;
      margin: 10px 0;
    }
    .demo-button {
      background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 1em;
      margin: 5px;
    }
    .demo-button:hover {
      background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
    }
    .output-box {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
    }
    .flag-reveal {
      background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin: 15px 0;
      text-align: center;
      font-weight: bold;
      font-size: 1.2em;
      display: none;
    }
    .hint-box {
      background: #fff3e0;
      border-left: 4px solid #ff9800;
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
    }
    code {
      background: #f5f5f5;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      color: #c62828;
    }
    pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      border: 1px solid #ddd;
      margin: 10px 0;
    }
    .back-link { text-align: center; margin-top: 30px; }
    .back-link a { color: #ff6b9d; text-decoration: none; font-weight: 600; }
    .footer {
      text-align: center;
      color: rgba(0,0,0,0.6);
      margin-top: 40px;
      padding: 20px;
    }
  </style>
`;

// Home page
app.get('/', (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>ShopTech Electronics</title>
      ${styles}
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>üíª ShopTech Electronics</h1>
          <p class="subtitle">Fresh. Healthy. Delicious.</p>
        </div>
        
        <div class="welcome-section">
          <h2>Welcome to ShopTech!</h2>
          <p>Order your favorite smoothies online for pickup or delivery. Browse our menu, search for your favorites, and manage your account.</p>
        </div>
        
        <div class="nav-cards">
          <a href="/example" class="card">
            <h3>üìö Getting Started</h3>
            <p>Learn about SQL injection vulnerabilities with interactive tutorials and examples.</p>
            <span class="card-badge badge-tutorial">Tutorial</span>
          </a>

          <a href="/lab1" class="card">
            <h3>üîç Search Menu</h3>
            <p>Explore our smoothie menu with a secure search feature. See how parameterized queries work!</p>
            <span class="card-badge badge-easy">Lab 1</span>
          </a>

          <a href="/lab2" class="card">
            <h3>üî¨ Advanced Search</h3>
            <p>Try advanced search with multiple filters. Can you detect SQL injection vulnerabilities?</p>
            <span class="card-badge badge-medium">Lab 2</span>
          </a>

          <a href="/lab3" class="card">
            <h3>üîê Customer Login</h3>
            <p>Access your account and rewards. Authentication system needs your testing skills!</p>
            <span class="card-badge badge-hard">Lab 3</span>
          </a>
        </div>

        <div class="footer">
          <p>üíª ShopTech Electronics ‚Ä¢ 789 Tech Avenue, Silicon Valley ‚Ä¢ (555) 987-6543</p>
        </div>
      </div>
    </body>
    </html>
  `);
});

// Example page - Product Catalog with DevTools Discovery
app.get('/example', (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>ShopTech Product Catalog</title>
      ${styles}
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>üõçÔ∏è ShopTech Product Catalog</h1>
          <p class="subtitle">Example: Discover Our Products</p>
        </div>

        <div class="welcome-section">
          <h2>Featured Electronics</h2>
          <p>Browse our selection of premium tech products. All items ship free within 2-3 business days.</p>
          
          <div class="hint-box" style="margin-top: 20px;">
            <strong>ÔøΩÔøΩ Discovery Tip:</strong> Use browser DevTools (F12 ‚Üí Network tab) to explore how this page loads product data.
          </div>
        </div>

        <div id="products-grid" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:20px; margin:30px 0;">
          <div style="text-align:center; padding:40px; color:#999;">Loading products...</div>
        </div>

        <div class="back-link">
          <a href="/">‚Üê Back to Home</a>
        </div>
      </div>

      <script>
        // Auto-load product data on page load (visible in DevTools Network tab)
        window.addEventListener('DOMContentLoaded', async () => {
          try {
            // Make API calls in sequence (discoverable in DevTools)
            await fetch('/api/example/products');
            await fetch('/api/example/products/list');
            await fetch('/api/example/products/featured');
            const debugResp = await fetch('/api/example/products/debug');
            const debugData = await debugResp.json();
            
            // Display products from debug endpoint
            const grid = document.getElementById('products-grid');
            if (debugData.products && debugData.products.length > 0) {
              grid.innerHTML = debugData.products.map(p => \`
                <div class="card">
                  <h3>\${p.name}</h3>
                  <p style="font-size:1.5em; color:#667eea; font-weight:bold;">$\${p.price}</p>
                  <p style="color:#666; font-size:0.9em;">\${p.category}</p>
                  <p style="color:#999; font-size:0.85em;">SKU: \${p.sku}</p>
                  <p style="color:#f39c12;">‚≠ê \${p.rating}/5</p>
                </div>
              \`).join('');
            }
          } catch (error) {
            document.getElementById('products-grid').innerHTML = 
              '<div style="color:red; padding:20px;">Error loading products</div>';
          }
        });
      </script>
    </body>
    </html>
  `);
});

// Example API - Part 1: Initial products endpoint
app.get('/api/example/products', (req, res) => {
  res.json({
    success: true,
    message: 'Part 1/4: Basic product endpoint',
    hint: 'Try /api/example/products/list for more details',
    count: products.length
  });
});

// Example API - Part 2: Product list
app.get('/api/example/products/list', (req, res) => {
  res.json({
    success: true,
    message: 'Part 2/4: Product list endpoint',
    hint: 'Check /api/example/products/featured for special items',
    products: products.slice(0, 4).map(p => ({
      id: p.id,
      name: p.name,
      price: p.price
    }))
  });
});

// Example API - Part 3: Featured products
app.get('/api/example/products/featured', (req, res) => {
  res.json({
    success: true,
    message: 'Part 3/4: Featured products',
    hint: 'There might be a debug endpoint with more information',
    featured: products.filter(p => p.rating >= 4.7)
  });
});

// Example API - Part 4: Debug endpoint with flag
app.get('/api/example/products/debug', (req, res) => {
  res.json({
    success: true,
    message: 'Part 4/4: Debug endpoint found!',
    flag: 'NSA{D3BUG_PR0DUCTS_F0UND}',
    products: products,
    debug_info: {
      database: 'shoptech_prod',
      version: '1.2.3',
      api_endpoints: [
        '/api/search',
        '/api/filter',
        '/api/process-image'
      ]
    }
  });
});

// Lab 1 - Secure Menu Search (EASY - demonstrates proper implementation)
// Lab 1 - SQL Injection via Product Search (Error-Based)
app.get('/lab1', (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Product Search - ShopTech</title>
      ${styles}
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>üîç Product Search</h1>
          <p class="subtitle">Lab 1: Find Your Perfect Tech</p>
        </div>

        <div class="welcome-section">
          <h2>Search Our Catalog</h2>
          <p>Search through our extensive product inventory by name, category, or specifications.</p>
          
          <div class="interactive-demo" style="margin-top: 30px;">
            <input type="text" id="search-input" class="demo-input" placeholder="Search products..." style="width: 70%; padding: 15px; font-size: 1.1em; border: 2px solid #ddd; border-radius: 8px;">
            <button onclick="searchProducts()" class="demo-button" style="padding: 15px 30px; font-size: 1.1em;">Search</button>
          </div>
          
          <div id="search-results" style="margin-top: 30px; min-height: 100px;"></div>
          
          <div class="hint-box" style="margin-top: 30px;">
            <strong>üí° Discovery Tip:</strong> Try using gobuster to discover search API endpoints:<br>
            <code>gobuster dir -u http://localhost:3005 -w /path/to/wordlist.txt</code>
          </div>
        </div>

        <div class="back-link">
          <a href="/">‚Üê Back to Home</a>
        </div>
      </div>

      <script>
        async function searchProducts() {
          const query = document.getElementById('search-input').value;
          const resultsDiv = document.getElementById('search-results');
          
          if (!query) {
            resultsDiv.innerHTML = '<p style="color:#999;">Please enter a search term</p>';
            return;
          }
          
          resultsDiv.innerHTML = '<p style="color:#667eea;">Searching...</p>';
          
          try {
            const response = await fetch('/api/search?q=' + encodeURIComponent(query));
            const data = await response.json();
            
            if (data.error) {
              resultsDiv.innerHTML = \`
                <div style="background:#ffebee; border-left:4px solid #c62828; padding:20px; border-radius:8px;">
                  <h3 style="color:#c62828; margin-bottom:10px;">‚ùå Search Error</h3>
                  <pre style="background:#fff; padding:15px; border-radius:5px; overflow-x:auto; font-size:0.9em;">\${data.error}</pre>
                  \${data.flag ? '<p style="color:#2e7d32; font-weight:bold; margin-top:15px;">üéØ Flag: ' + data.flag + '</p>' : ''}
                </div>
              \`;
            } else if (data.results && data.results.length > 0) {
              resultsDiv.innerHTML = \`
                <h3 style="color:#667eea; margin-bottom:15px;">Found \${data.results.length} product(s):</h3>
                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:15px;">
                  \${data.results.map(p => \`
                    <div class="card">
                      <h4>\${p.name}</h4>
                      <p style="font-size:1.3em; color:#667eea; font-weight:bold;">$\${p.price}</p>
                      <p style="color:#666;">\${p.category}</p>
                      <p style="color:#999; font-size:0.85em;">SKU: \${p.sku}</p>
                    </div>
                  \`).join('')}
                </div>
              \`;
            } else {
              resultsDiv.innerHTML = '<p style="color:#999;">No products found matching your search.</p>';
            }
          } catch (error) {
            resultsDiv.innerHTML = '<p style="color:#c62828;">Connection error: ' + error.message + '</p>';
          }
        }
        
        // Allow Enter key to search
        document.getElementById('search-input').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') searchProducts();
        });
      </script>
    </body>
    </html>
  `);
});

// Lab 1 API - VULNERABLE: SQL Injection in search
app.get('/api/search', (req, res) => {
  const query = req.query.q || '';
  
  if (!query) {
    return res.json({
      success: false,
      message: 'Please provide a search term'
    });
  }
  
  // VULNERABLE: Direct string concatenation in SQL query
  const vulnerableQuery = `SELECT * FROM products WHERE name LIKE '%${query}%' OR category LIKE '%${query}%' OR sku LIKE '%${query}%'`;
  
  // Detect SQL injection attempts
  const hasSQLChars = query.includes("'") || query.includes('"') || query.includes('--') || 
                      query.toLowerCase().includes(' or ') || query.toLowerCase().includes(' and ') ||
                      query.toLowerCase().includes('union') || query.includes(';');
  
  if (hasSQLChars) {
    // Simulate SQL error message that would be thrown by real database
    return res.status(500).json({
      error: `SQL Error: You have an error in your SQL syntax near '${query}' at line 1

Query: ${vulnerableQuery}

Database: shoptech_prod
Table: products
Columns: id, name, price, category, stock, sku, rating

Connection String: postgres://shoptech_user:Sh0pT3ch2024!@db.shoptech.io:5432/shoptech_prod

Stack Trace:
  at executeQuery (/app/database/query.js:156:12)
  at searchProducts (/app/api/search.js:42:18)
  at processRequest (/app/server.js:672:24)`,
      flag: 'NSA{SQL_3RR0R_1NJ3CT}',
      vulnerable_query: vulnerableQuery,
      hint: 'SQL injection detected! The error message exposed sensitive database information.'
    });
  }
  
  // Normal search - filter products
  const results = products.filter(p => 
    p.name.toLowerCase().includes(query.toLowerCase()) ||
    p.category.toLowerCase().includes(query.toLowerCase()) ||
    p.sku.toLowerCase().includes(query.toLowerCase())
  );
  
  res.json({
    success: true,
    query: query,
    results: results,
    count: results.length
  });
});

app.get('/lab2', (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Advanced Search - ShopTech</title>
      ${styles}
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>üî¨ Advanced Search</h1>
          <p class="subtitle">Refined search with multiple filters</p>
        </div>

        <div class="tutorial-section">
          <h2>Multi-Filter Search</h2>
          <p>Search with additional filters to find exactly what you're looking for!</p>
          
          <div class="tutorial-box">
            <h3>üéØ Lab 2 Challenge</h3>
            <p>This search has a <strong>SQL injection vulnerability</strong>! Can you find it?</p>
            <p>Try injecting SQL into the search field or category:</p>
            <ul>
              <li><code>berry'</code> - Single quote causes SQL error</li>
              <li><code>test' OR '1'='1</code> - OR-based injection</li>
              <li><code>test'--</code> - Comment-based injection</li>
        <div class="tutorial-section">
          <h2>Advanced Product Search</h2>
          <p>Refine your search with category filters and specific criteria.</p>

          <div class="interactive-demo">
            <h3>Search with Filters</h3>
            <div class="demo-controls">
              <label style="display: block; margin-top: 10px; font-weight: 600;">Search Term:</label>
              <input type="text" id="adv-search-input" class="demo-input" placeholder="Enter product name or specs" value="">
              
              <label style="display: block; margin-top: 10px; font-weight: 600;">Category:</label>
              <input type="text" id="adv-category-input" class="demo-input" placeholder="e.g., Electronics, Accessories" value="">
              
              <button onclick="advancedSearch()" class="demo-button">üîç Search</button>
            </div>
            <div id="adv-search-output" class="output-box"></div>
          </div>
        </div>

        <div class="back-link">
          <a href="/">‚Üê Back to Home</a>
        </div>
      </div>

      <script>
        async function advancedSearch() {
          const query = document.getElementById('adv-search-input').value;
          const category = document.getElementById('adv-category-input').value;
          const output = document.getElementById('adv-search-output');
          
          if (!query && !category) {
            output.textContent = 'Please enter a search term or category';
            return;
          }
          
          output.textContent = 'Searching...';
          
          try {
            let url = '/api/advanced-search?';
            if (query) url += 'q=' + encodeURIComponent(query);
            if (category) url += (query ? '&' : '') + 'category=' + encodeURIComponent(category);
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.results && data.results.length > 0) {
              let displayText = 'Found ' + data.results.length + ' product(s):\\n\\n';
              data.results.forEach(s => {
                displayText += s.name + ' - $' + s.price + '\\n';
              });
              output.textContent = displayText;
            } else {
              output.textContent = 'No products found';
            }
          } catch (error) {
            output.textContent = 'Error: ' + error.message;
          }
        }
      </script>
    </body>
    </html>
  `);
});

// Lab 2 API - Vulnerable advanced search
app.get('/api/advanced-search', (req, res) => {
  const query = req.query.q || '';
  const category = req.query.category || '';
  
  // Simulated vulnerable query with string concatenation
  const simulatedSQL = `SELECT * FROM smoothies WHERE name LIKE '%${query}%' AND category = '${category}'`;
  
  // Check for SQL injection attempts
  const sqlInjectionPatterns = ["'", '"', '--', '#', '/*', '*/', 'UNION', 'SELECT', 'DROP', 'INSERT', 'DELETE', 'UPDATE', ' OR ', '1=1'];
  const injectionDetected = sqlInjectionPatterns.some(pattern => 
    query.toLowerCase().includes(pattern.toLowerCase()) || 
    category.toLowerCase().includes(pattern.toLowerCase())
  );
  
  if (injectionDetected) {
    // SQL error response when injection detected
    return res.json({
      success: false,
      error: 'SQL Error Detected',
      flag: 'NSA{SQL_3RR0R_F0UND}',
      message: 'SQL injection vulnerability confirmed!',
      hint: 'The query was: ' + simulatedSQL,
      sql_error: "Syntax error near '" + (query || category) + "' in WHERE clause",
      technical_info: 'SQL injection pattern detected in search parameters',
      vulnerability: 'String concatenation allows SQL injection',
      impact: 'Attackers could retrieve all data, bypass filters, or even modify the database',
      remediation: 'Use parameterized queries: db.query(sql, [param1, param2])'
    });
  }
  
  // Normal search (no injection)
  let results = smoothies;
  
  if (query) {
    results = results.filter(s => 
      s.name.toLowerCase().includes(query.toLowerCase()) ||
      s.ingredients.toLowerCase().includes(query.toLowerCase())
    );
  }
  
  if (category) {
    results = results.filter(s => 
      s.category.toLowerCase() === category.toLowerCase()
    );
  }
  
  res.json({
    success: true,
    query: simulatedSQL,
    results: results,
    total: results.length,
    note: 'Try SQL injection payloads to discover the vulnerability!'
  });
});

// Lab 3 - Customer Login (HARD - authentication bypass)
app.get('/lab3', (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Customer Login - ShopTech</title>
      ${styles}
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>üîê Customer Login</h1>
          <p class="subtitle">Access your account and rewards</p>
        </div>

        <div class="tutorial-section">
          <h2>Sign In to Your Account</h2>
          <p>Login to view your order history, manage rewards points, and save your favorite smoothies!</p>
          
          <div class="tutorial-box">
            <h3>üéØ Lab 3 Challenge</h3>
            <p>This login form is <strong>vulnerable to SQL injection</strong>! Can you bypass authentication?</p>
            <p>Try these techniques:</p>
            <ul>
              <li><strong>Comment-based:</strong> <code>admin@shoptech.com'--</code> in email (any password)</li>
        <div class="tutorial-section">
          <h2>Customer Login</h2>
          <p>Sign in to access your account, order history, and rewards.</p>

          <div class="interactive-demo">
            <h3>Login Form</h3>
            <div class="demo-controls">
              <label style="display: block; margin-top: 10px; font-weight: 600;">Email:</label>
              <input type="text" id="login-email" class="demo-input" placeholder="your.email@example.com" value="">
              
              <label style="display: block; margin-top: 10px; font-weight: 600;">Password:</label>
              <input type="password" id="login-password" class="demo-input" placeholder="Enter your password" value="">
              
              <button onclick="loginCustomer()" class="demo-button">üîì Sign In</button>
            </div>
            <div id="login-output" class="output-box"></div>
            <div id="login-flag" class="flag-reveal"></div>
          </div>

          <div style="margin-top: 20px; padding: 15px; background: #F5F5F5; border-radius: 8px;">
            <strong>Need an account?</strong><br>
            <a href="#" style="color: #0066cc;">Create new account</a> | <a href="#" style="color: #0066cc;">Forgot password?</a>
          </div>
        </div>

        <div class="back-link">
          <a href="/">‚Üê Back to Home</a>
        </div>
      </div>

      <script>
        async function loginCustomer() {
          const email = document.getElementById('login-email').value;
          const password = document.getElementById('login-password').value;
          const output = document.getElementById('login-output');
          const flagDiv = document.getElementById('login-flag');
          
          if (!email || !password) {
            output.textContent = 'Please enter both email and password';
            return;
          }
          
          output.textContent = 'Authenticating...';
          flagDiv.style.display = 'none';
          
          try {
            const response = await fetch('/api/login', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ email, password })
            });
            
            const data = await response.json();
            
            if (data.success) {
              flagDiv.textContent = '‚úì Login successful! Welcome, ' + (data.customer?.name || 'Customer');
              flagDiv.style.display = 'block';
              flagDiv.style.background = 'linear-gradient(135deg, #4caf50 0%, #2e7d32 100%)';
              output.textContent = '';
            } else {
              output.textContent = 'Login failed: ' + data.message;
            }
          } catch (error) {
            output.textContent = 'Error: ' + error.message;
          }
        }
      </script>
    </body>
    </html>
  `);
});

// Lab 3 API - Vulnerable login
app.post('/api/login', (req, res) => {
  const { email, password } = req.body;
  
  if (!email || !password) {
    return res.json({
      success: false,
      message: 'Email and password are required'
    });
  }

  // Simulated vulnerable SQL query
  const simulatedSQL = `SELECT * FROM customers WHERE email='${email}' AND password='${password}'`;
  
  // Check for SQL injection patterns that bypass authentication
  const bypassPatterns = [
    { pattern: "' OR '1'='1", name: 'OR-based injection' },
    { pattern: "' OR 1=1", name: 'OR-based injection (numeric)' },
    { pattern: "'--", name: 'Comment-based injection' },
    { pattern: "' #", name: 'Comment-based injection (hash)' },
    { pattern: "admin@shoptech.com'--", name: 'Direct admin bypass' }
  ];
  
  const injectionDetected = bypassPatterns.some(p => 
    email.includes(p.pattern) || password.includes(p.pattern)
  );
  
  if (injectionDetected) {
    // Successful SQL injection bypass
    return res.json({
      success: true,
      message: 'Authentication successful (via SQL injection!)',
      flag: 'NSA{SQL_4UTH_BYP4SS3D}',
      customer: {
        email: 'admin@shoptech.com',
        name: 'Sarah Manager',
        role: 'admin',
        rewards_points: 850,
        favorite: 'Protein Power',
        id: 1
      },
      sql_injection: true,
      query_executed: simulatedSQL,
      exploitation_note: 'SQL injection used to bypass authentication',
      vulnerability: 'String concatenation in WHERE clause allows authentication bypass',
      impact: 'Attacker gained admin access without knowing the password!',
      remediation: 'Use parameterized queries AND hashed passwords with bcrypt'
    });
  }
  
  // Normal authentication (for legitimate logins)
  const customer = customers.find(c => c.email === email && c.password === password);
  
  if (customer) {
    const { password: pwd, ...customerData } = customer;
    return res.json({
      success: true,
      message: 'Login successful',
      customer: customerData,
      note: 'This was a legitimate login. Try SQL injection to get the flag!'
    });
  }
  
  // Failed login
  res.status(401).json({
    success: false,
    message: 'Invalid email or password',
    query_executed: simulatedSQL,
    hint: 'Try SQL injection techniques to bypass authentication!',
    examples: [
      "Email: admin@shoptech.com'-- (with any password)",
      "Email: ' OR '1'='1 (with any password)",
      "Password: ' OR '1'='1 (with any email)"
    ]
  });
});

// Server startup
app.listen(PORT, '0.0.0.0', () => {
  console.log(`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   üíª ShopTech E-Commerce                   ‚ïë
‚ïë   SQL Injection Training Lab               ‚ïë
‚ïë   Server running on port ${PORT}              ‚ïë
‚ïë                                            ‚ïë
‚ïë   Access: http://localhost:${PORT}            ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

Available pages:
  http://localhost:${PORT}/ - Home
  http://localhost:${PORT}/example - SQL Injection Tutorial
  http://localhost:${PORT}/lab1 - Lab 1: Secure Search (EASY)
  http://localhost:${PORT}/lab2 - Lab 2: Advanced Search (MEDIUM)
  http://localhost:${PORT}/lab3 - Lab 3: Login Bypass (HARD)
`);
});
