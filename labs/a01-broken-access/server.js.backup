const express = require('express');
const app = express();
const PORT = process.env.PORT || 3000;

app.use(express.json());
app.use(express.static('public'));

// Users database - ZenFlow Yoga Studio Members
const users = [
    { id: 1, username: 'emma_s', email: 'emma.stevens@email.com', role: 'member', membership: 'Premium', creditCard: '**** 4532', renewalDate: '2025-03-15', joinDate: '2023-01-15', favoriteClass: 'Vinyasa Flow' },
    { id: 2, username: 'sarah_m', email: 'sarah.martinez@email.com', role: 'member', membership: 'Basic', creditCard: '**** 7821', renewalDate: '2025-02-28', joinDate: '2024-06-20', favoriteClass: 'Hatha Yoga' },
    { id: 3, username: 'mike_chen', email: 'mike.chen@email.com', role: 'member', membership: 'Premium', creditCard: '**** 3345', renewalDate: '2025-04-10', joinDate: '2023-09-08', favoriteClass: 'Power Yoga' },
    { id: 4, username: 'instructor_jane', email: 'jane.williams@zenflow.yoga', role: 'instructor', membership: 'Staff', creditCard: '**** 9012', accessLevel: 'full', specialization: 'Vinyasa & Meditation', yearsTeaching: 8 }
];

const CURRENT_USER_ID = 2; // Sarah is the current logged-in member

// Home page
app.get('/', (req, res) => {
    res.send(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>ZenFlow Yoga - Member Portal</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                    background: linear-gradient(135deg, #e8f5e9 0%, #c5e1a5 100%);
                    min-height: 100vh;
                    padding: 20px;
                }
                .header {
                    background: white;
                    padding: 20px 40px;
                    border-radius: 15px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
                    margin-bottom: 30px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                .logo {
                    font-size: 2em;
                    font-weight: 600;
                    background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                }
                .user-info {
                    font-size: 0.9em;
                    color: #666;
                }
                .container {
                    max-width: 1200px;
                    margin: 0 auto;
                }
                .welcome-section {
                    background: white;
                    padding: 40px;
                    border-radius: 15px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
                    margin-bottom: 30px;
                }
                .welcome-section h1 {
                    color: #2e7d32;
                    margin-bottom: 15px;
                    font-size: 2.2em;
                }
                .welcome-section p {
                    color: #555;
                    line-height: 1.8;
                    font-size: 1.1em;
                }
                .nav-cards {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                    gap: 20px;
                    margin-top: 20px;
                }
                .card {
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
                    transition: transform 0.2s, box-shadow 0.2s;
                    text-decoration: none;
                    color: inherit;
                    display: block;
                    border-left: 4px solid #66bb6a;
                }
                .card:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 4px 20px rgba(0,0,0,0.12);
                }
                .card h3 {
                    color: #2e7d32;
                    margin-bottom: 15px;
                    font-size: 1.4em;
                }
                .card p {
                    color: #666;
                    line-height: 1.6;
                    margin-bottom: 15px;
                }
                .card-badge {
                    display: inline-block;
                    padding: 6px 14px;
                    border-radius: 20px;
                    font-size: 0.75em;
                    font-weight: 600;
                    margin-top: 10px;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                .badge-tutorial { background: #e3f2fd; color: #1976d2; }
                .badge-easy { background: #e8f5e9; color: #388e3c; }
                .badge-medium { background: #fff3e0; color: #f57c00; }
                .badge-hard { background: #ffebee; color: #d32f2f; }
                .footer {
                    text-align: center;
                    color: rgba(0,0,0,0.6);
                    margin-top: 40px;
                    padding: 20px;
                }
                .footer a {
                    color: rgba(0,0,0,0.6);
                    text-decoration: none;
                    transition: color 0.2s;
                }
                .footer a:hover {
                    color: #2e7d32;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <div class="logo">üßò ZenFlow Yoga</div>
                    <div class="user-info">
                        Logged in as: <strong>sarah_m</strong> (Member #${CURRENT_USER_ID})
                    </div>
                </div>

                <div class="welcome-section">
                    <h1>Welcome to Your Member Portal, Sarah! üå∏</h1>
                    <p>Namaste! Access your membership details, connect with our community, view upcoming classes, and manage your account‚Äîall in one place.</p>
                </div>

                <div class="nav-cards">
                    <a href="/example" class="card">
                        <h3>üìö Getting Started Guide</h3>
                        <p>New to our portal? Learn how to make the most of your membership, book classes, and update your preferences.</p>
                        <span class="card-badge badge-tutorial">Help Center</span>
                    </a>

                    <a href="/lab1" class="card">
                        <h3>üë• Community Directory</h3>
                        <p>Connect with fellow members and instructors in our vibrant yoga community.</p>
                        <span class="card-badge badge-easy">Community</span>
                    </a>

                    <a href="/lab2" class="card">
                        <h3>üë§ My Profile</h3>
                        <p>View and manage your membership details, payment information, and personal preferences.</p>
                        <span class="card-badge badge-medium">Account</span>
                    </a>

                    <a href="/lab3" class="card">
                        <h3>üìÖ Instructor Dashboard</h3>
                        <p>Instructor-only area for managing class schedules, viewing bookings, and accessing teaching resources.</p>
                        <span class="card-badge badge-hard">Staff Access</span>
                    </a>
                </div>

                <div class="footer">
                    <p>üßò ZenFlow Yoga Studio ‚Ä¢ 123 Peaceful Lane, Downtown ‚Ä¢ (555) 123-4567</p>
                    <p style="margin-top: 10px; font-size: 0.9em;">
                        <a href="/about">About Us</a> | 
                        <a href="/contact">Contact</a> | 
                        <a href="/classes">Class Schedule</a> | 
                        <a href="/membership">Membership Plans</a>
                    </p>
                </div>
            </div>
        </body>
        </html>
    `);
});

// Example page - Member Portal Guide
app.get('/example', (req, res) => {
    res.send(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Getting Started - ZenFlow Yoga</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                    background: linear-gradient(135deg, #e8f5e9 0%, #c5e1a5 100%);
                    min-height: 100vh;
                    padding: 20px;
                    line-height: 1.6;
                }
                .container {
                    max-width: 900px;
                    margin: 0 auto;
                }
                .header {
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
                    margin-bottom: 30px;
                    text-align: center;
                }
                h1 {
                    color: #2e7d32;
                    font-size: 2.5em;
                    margin-bottom: 10px;
                }
                .subtitle {
                    color: #666;
                    font-size: 1.1em;
                }
                .section {
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
                    margin-bottom: 25px;
                    border-left: 4px solid #66bb6a;
                }
                .section h2 {
                    color: #2e7d32;
                    margin-bottom: 15px;
                    font-size: 1.8em;
                }
                .section h3 {
                    color: #43a047;
                    margin-top: 20px;
                    margin-bottom: 10px;
                }
                .section p {
                    color: #555;
                    margin-bottom: 15px;
                    line-height: 1.7;
                }
                .feature-box {
                    background: #f1f8e9;
                    padding: 20px;
                    border-radius: 10px;
                    margin: 15px 0;
                    border-left: 3px solid #66bb6a;
                }
                .tip-box {
                    background: #fff3e0;
                    border-left: 4px solid #fb8c00;
                    padding: 15px;
                    margin: 15px 0;
                    border-radius: 5px;
                }
                ul {
                    margin-left: 20px;
                    margin-bottom: 15px;
                }
                ul li {
                    margin: 8px 0;
                    color: #555;
                }
                .btn {
                    display: inline-block;
                    background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
                    color: white;
                    padding: 12px 30px;
                    border-radius: 25px;
                    text-decoration: none;
                    font-weight: 600;
                    transition: transform 0.2s;
                    margin-top: 10px;
                }
                .btn:hover {
                    transform: translateY(-2px);
                }
                .back-link {
                    text-align: center;
                    margin-top: 30px;
                }
                .back-link a {
                    color: #2e7d32;
                    text-decoration: none;
                    font-weight: 600;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>üßò Getting Started with Your Member Portal</h1>
                    <p class="subtitle">Everything you need to know about accessing and managing your ZenFlow membership</p>
                </div>

                <div class="section">
                    <h2>üåü Welcome to ZenFlow!</h2>
                    <p>We're thrilled to have you as part of our yoga community. This guide will help you navigate your member portal and make the most of your membership.</p>
                    
                    <div class="feature-box">
                        <h3>Your Member Benefits</h3>
                        <ul>
                            <li><strong>Unlimited Class Access:</strong> Book any class through our scheduling system</li>
                            <li><strong>Community Directory:</strong> Connect with fellow yoga enthusiasts</li>
                            <li><strong>Personal Profile:</strong> Track your progress and manage your account</li>
                            <li><strong>Online Resources:</strong> Access meditation guides and yoga tutorials</li>
                        </ul>
                    </div>
                </div>

                <div class="section">
                    <h2>üë• Exploring the Community Directory</h2>
                    <p>Our Community Directory helps you connect with other members and instructors. You can:</p>
                    <ul>
                        <li>Browse member profiles to find yoga buddies</li>
                        <li>View instructor specializations and teaching styles</li>
                        <li>Send messages to coordinate carpools or study groups</li>
                    </ul>
                    
                    <div class="tip-box">
                        üí° <strong>Tip:</strong> The directory shows basic contact information for all members. Visit the Community Directory to see who shares your interests!
                    </div>
                </div>

                <div class="section">
                    <h2>üë§ Managing Your Profile</h2>
                    <p>Your profile is your personal space to manage everything related to your membership:</p>
                    
                    <h3>What's in Your Profile:</h3>
                    <ul>
                        <li><strong>Membership Details:</strong> View your current plan and renewal date</li>
                        <li><strong>Payment Information:</strong> Manage your payment methods securely</li>
                        <li><strong>Class History:</strong> Track which classes you've attended</li>
                        <li><strong>Personal Preferences:</strong> Set your favorite class types and instructors</li>
                    </ul>
                    
                    <div class="feature-box">
                        <h3>Privacy & Security</h3>
                        <p>Your profile information is private and only visible to you. We use industry-standard security to protect your payment details and personal data.</p>
                    </div>
                </div>

                <div class="section">
                    <h2>üìÖ Class Booking & Scheduling</h2>
                    <p>Booking classes is easy! Here's how:</p>
                    <ol style="margin-left: 20px; color: #555;">
                        <li>Visit the Class Schedule page from the main menu</li>
                        <li>Browse upcoming classes by date, instructor, or style</li>
                        <li>Click "Book Now" on any class that interests you</li>
                        <li>Receive a confirmation email with class details</li>
                    </ol>
                    
                    <div class="tip-box">
                        üí° <strong>Tip:</strong> Premium members can book classes up to 30 days in advance, while Basic members can book 7 days ahead.
                    </div>
                </div>

                <div class="section">
                    <h2>üìû Need Help?</h2>
                    <p>Our team is here to support you on your yoga journey:</p>
                    <ul>
                        <li><strong>Email:</strong> support@zenflow.yoga</li>
                        <li><strong>Phone:</strong> (555) 123-4567</li>
                        <li><strong>Visit Us:</strong> 123 Peaceful Lane, Downtown</li>
                        <li><strong>Hours:</strong> Monday-Friday 6am-8pm, Saturday-Sunday 7am-6pm</li>
                    </ul>
                </div>

                <div class="back-link">
                    <a href="/">‚Üê Back to Member Portal</a>
                </div>
            </div>
        </body>
        </html>
    `);
});

// Lab 1 - Community Directory
app.get('/lab1', (req, res) => {
    res.send(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Community Directory - ZenFlow Yoga</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                    background: linear-gradient(135deg, #e8f5e9 0%, #c5e1a5 100%);
                    min-height: 100vh;
                    padding: 20px;
                    line-height: 1.6;
                }
                .container {
                    max-width: 900px;
                    margin: 0 auto;
                }
                .header {
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
                    margin-bottom: 30px;
                    text-align: center;
                }
                h1 {
                    color: #2e7d32;
                    font-size: 2.5em;
                    margin-bottom: 10px;
                }
                .subtitle {
                    color: #666;
                    font-size: 1.1em;
                }
                .info-section {
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
                    margin-bottom: 25px;
                    border-left: 4px solid #66bb6a;
                }
                .info-section h2 {
                    color: #2e7d32;
                    margin-bottom: 15px;
                }
                .info-section p {
                    color: #555;
                    margin-bottom: 15px;
                }
                .search-box {
                    background: #f1f8e9;
                    padding: 25px;
                    border-radius: 10px;
                    margin: 20px 0;
                }
                .search-input {
                    width: 100%;
                    padding: 12px;
                    border: 2px solid #66bb6a;
                    border-radius: 8px;
                    font-size: 1em;
                    margin-top: 10px;
                }
                .member-card {
                    background: white;
                    padding: 20px;
                    border-radius: 10px;
                    margin: 15px 0;
                    box-shadow: 0 1px 5px rgba(0,0,0,0.1);
                    border-left: 3px solid #66bb6a;
                }
                .member-name {
                    color: #2e7d32;
                    font-size: 1.3em;
                    font-weight: 600;
                    margin-bottom: 5px;
                }
                .member-info {
                    color: #666;
                    font-size: 0.95em;
                }
                .tip-box {
                    background: #fff3e0;
                    border-left: 4px solid #fb8c00;
                    padding: 15px;
                    margin: 20px 0;
                    border-radius: 5px;
                }
                .back-link {
                    text-align: center;
                    margin-top: 30px;
                }
                .back-link a {
                    color: #2e7d32;
                    text-decoration: none;
                    font-weight: 600;
                }
                code {
                    background: #f5f5f5;
                    padding: 2px 6px;
                    border-radius: 3px;
                    font-family: 'Courier New', monospace;
                    color: #c62828;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>üë• Community Directory</h1>
                    <p class="subtitle">Connect with fellow yoga enthusiasts and instructors</p>
                </div>

                <div class="info-section">
                    <h2>Welcome to Our Community</h2>
                    <p>The ZenFlow Community Directory helps you connect with other members who share your passion for yoga. Browse member profiles, find practice partners, and get to know our instructors.</p>
                    
                    <div class="search-box">
                        <strong>üîç Search for Members</strong>
                        <input type="text" class="search-input" placeholder="Enter member ID (e.g., 1, 2, 3...)" id="searchInput">
                        <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                            Try searching by member ID to view their public profile. You can find member IDs through class rosters or community events.
                        </p>
                    </div>
                </div>

                <div class="info-section">
                    <h2>Featured Members</h2>
                    
                    <div class="member-card">
                        <div class="member-name">Sarah Martinez (You)</div>
                        <div class="member-info">
                            üìß sarah.martinez@email.com<br>
                            üé´ Basic Membership<br>
                            üí´ Favorite Class: Hatha Yoga
                        </div>
                    </div>
                    
                    <div class="tip-box">
                        üí° <strong>How to Connect:</strong> Use the member lookup API to find other members by their ID. The API returns basic contact information to help you connect with your community.
                    </div>
                </div>

                <div class="info-section">
                    <h2>üì° API Information</h2>
                    <p>Developers and members can use our API to programmatically access the directory:</p>
                    <p style="margin-top: 15px;">
                        <strong>Endpoint:</strong> <code>GET /api/members/user/:id</code><br>
                        <strong>Example:</strong> <code>GET /api/members/user/2</code>
                    </p>
                    <p style="margin-top: 15px; color: #666; font-size: 0.95em;">
                        This endpoint returns public profile information for community members. All members can view basic contact details to facilitate connections within our yoga community.
                    </p>
                </div>

                <div class="back-link">
                    <a href="/">‚Üê Back to Member Portal</a>
                </div>
            </div>
            
            <script>
                document.getElementById('searchInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const id = this.value.trim();
                        if (id) {
                            window.location.href = '/api/members/user/' + id;
                        }
                    }
                });
            </script>
        </body>
        </html>
    `);
});

// Lab 1 API - Community directory endpoint (vulnerable to enumeration)
app.get('/api/members/user/:id', (req, res) => {
    const userId = parseInt(req.params.id);
    const user = users.find(u => u.id === userId);
    
    if (!user) {
        return res.status(404).json({ 
            error: 'Member not found',
            message: 'No member exists with this ID in our directory.'
        });
    }
    
    // Vulnerable: Returns user info without proper access control
    // Only show flag when ALL users have been discovered
    const foundUsers = users.filter(u => u.id <= userId).length;
    
    if (foundUsers === 4 && userId === 4) {
        return res.json({
            id: user.id,
            username: user.username,
            email: user.email,
            role: user.role,
            membership: user.membership,
            flag: 'FLAG{C0MMUN1TY_3NUM3R4T10N_C0MPL3T3}',
            message: 'You have successfully enumerated all community members!',
            stats: {
                totalMembers: users.length,
                members: users.filter(u => u.role === 'member').length,
                instructors: users.filter(u => u.role === 'instructor').length
            }
        });
    }
    
    // Normal response - looks like legitimate directory data
    const response = {
        id: user.id,
        username: user.username,
        email: user.email,
        role: user.role,
        membership: user.membership
    };
    
    // Add extra info for members
    if (user.role === 'member') {
        response.joinDate = user.joinDate;
        response.favoriteClass = user.favoriteClass;
    }
    
    // Add extra info for instructors
    if (user.role === 'instructor') {
        response.specialization = user.specialization;
        response.yearsTeaching = user.yearsTeaching;
    }
    
    return res.json(response);
});

// Lab 2 - My Profile
app.get('/lab2', (req, res) => {
    res.send(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Lab 2 - Profile Access</title>
            <style>
                body {
                    background-color: #1a1a1a;
                    color: #00ff00;
                    font-family: 'Courier New', monospace;
                    padding: 20px;
                    line-height: 1.6;
                }
                .container {
                    max-width: 900px;
                    margin: 0 auto;
                }
                h1 {
                    text-align: center;
                    font-size: 2.5em;
                    text-shadow: 0 0 10px #00ff00;
                    border-bottom: 2px solid #00ff00;
                    padding-bottom: 10px;
                }
                .info-box {
                    background-color: #0a0a0a;
                    border: 2px solid #00ff00;
                    padding: 20px;
                    margin: 20px 0;
                    border-radius: 5px;
                }
                .hint-box {
                    background-color: #0a0a0a;
                    border-left: 4px solid #ffaa00;
                    padding: 15px;
                    margin: 20px 0;
                }
                .endpoint {
                    background-color: #000;
                    padding: 15px;
                    border-radius: 5px;
                    border-left: 4px solid #00ffff;
                    margin: 15px 0;
                    font-family: monospace;
                }
                code {
                    color: #00ffff;
                }
                a {
                    color: #00ffff;
                    text-decoration: none;
                    border-bottom: 1px dotted #00ffff;
                }
                a:hover {
                    color: #00ff00;
                    border-bottom: 1px solid #00ff00;
                }
                .difficulty {
                    display: inline-block;
                    padding: 5px 15px;
                    border-radius: 3px;
                    font-weight: bold;
                    background-color: #ffaa00;
                    color: #000;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üé≠ LAB 2: PROFILE ACCESS <span class="difficulty">MEDIUM</span></h1>
                
                <div class="info-box">
                    <h2>üìã Mission Brief</h2>
                    <p><strong>Stage:</strong> Initial Access</p>
                    <p><strong>Objective:</strong> Access another user's private profile data</p>
                    <p><strong>Current User:</strong> Bob (ID: ${CURRENT_USER_ID})</p>
                    <p><strong>Flag:</strong> Will be revealed when you access someone else's profile</p>
                </div>

                <div class="info-box">
                    <h2>üéØ Challenge Description</h2>
                    <p>Users have profile pages containing sensitive information like Social Security Numbers. The application should only allow users to view their own profile.</p>
                    <p>You are logged in as Bob (User ID: ${CURRENT_USER_ID}). Can you access another user's private profile information?</p>
                </div>

                <div class="endpoint">
                    <strong>API Endpoint:</strong><br>
                    <code>GET http://localhost:3001/api/lab2/user/:id/profile</code><br><br>
                    <strong>Your Profile:</strong><br>
                    <code>GET http://localhost:3001/api/lab2/user/${CURRENT_USER_ID}/profile</code><br><br>
                    <strong>Try accessing:</strong><br>
                    <code>GET http://localhost:3001/api/lab2/user/1/profile</code>
                </div>

                <div class="hint-box">
                    <strong>üí° Hints:</strong>
                    <ul>
                        <li>The endpoint checks if you're logged in (you are - as Bob)</li>
                        <li>But does it check WHOSE profile you're accessing?</li>
                        <li>Try accessing profiles with different user IDs</li>
                        <li>Your goal is to view someone else's SSN</li>
                    </ul>
                </div>

                <div class="info-box">
                    <h2>üõ†Ô∏è Testing Instructions</h2>
                    <p><strong>Using curl:</strong></p>
                    <pre><code>curl http://localhost:3001/api/lab2/user/2/profile  # Your profile
curl http://localhost:3001/api/lab2/user/1/profile  # Alice's profile?
curl http://localhost:3001/api/lab2/user/3/profile  # Charlie's profile?</code></pre>
                    
                    <p><strong>Using Browser Console (F12):</strong></p>
                    <pre><code>fetch('http://localhost:3001/api/lab2/user/1/profile')
    .then(r => r.json())
    .then(data => console.log(data));</code></pre>
                </div>

                <div style="text-align: center; margin-top: 40px;">
                    <a href="/">‚Üê Back to Home</a>
                </div>
            </div>
        </body>
        </html>
    `);
});

// Lab 2 API - Profile access endpoint (vulnerable to IDOR)
app.get('/api/lab2/user/:id/profile', (req, res) => {
    const userId = parseInt(req.params.id);
    const user = users.find(u => u.id === userId);
    
    if (!user) {
        return res.status(404).json({ error: 'User not found' });
    }
    
    // Vulnerable: Checks that someone is logged in, but not WHO is accessing
    // In a real app, this would check req.session.userId
    // For this lab, we simulate that Bob (ID 2) is always logged in
    
    // If accessing someone else's profile
    if (userId !== CURRENT_USER_ID) {
        return res.json({
            id: user.id,
            username: user.username,
            email: user.email,
            ssn: user.ssn,
            flag: 'NSA{1D0R_V1A_1NC3PT10N}',
            message: `Congratulations! You accessed ${user.username}'s private profile data using IDOR.`
        });
    }
    
    // Accessing own profile
    return res.json({
        id: user.id,
        username: user.username,
        email: user.email,
        ssn: user.ssn,
        message: 'This is your own profile. Try accessing another user\'s profile!'
    });
});

// Lab 3 - Privilege Escalation (Hard)
app.get('/lab3', (req, res) => {
    res.send(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Lab 3 - Privilege Escalation</title>
            <style>
                body {
                    background-color: #1a1a1a;
                    color: #00ff00;
                    font-family: 'Courier New', monospace;
                    padding: 20px;
                    line-height: 1.6;
                }
                .container {
                    max-width: 900px;
                    margin: 0 auto;
                }
                h1 {
                    text-align: center;
                    font-size: 2.5em;
                    text-shadow: 0 0 10px #00ff00;
                    border-bottom: 2px solid #00ff00;
                    padding-bottom: 10px;
                }
                .info-box {
                    background-color: #0a0a0a;
                    border: 2px solid #00ff00;
                    padding: 20px;
                    margin: 20px 0;
                    border-radius: 5px;
                }
                .hint-box {
                    background-color: #0a0a0a;
                    border-left: 4px solid #ffaa00;
                    padding: 15px;
                    margin: 20px 0;
                }
                .endpoint {
                    background-color: #000;
                    padding: 15px;
                    border-radius: 5px;
                    border-left: 4px solid #00ffff;
                    margin: 15px 0;
                    font-family: monospace;
                }
                code {
                    color: #00ffff;
                }
                a {
                    color: #00ffff;
                    text-decoration: none;
                    border-bottom: 1px dotted #00ffff;
                }
                a:hover {
                    color: #00ff00;
                    border-bottom: 1px solid #00ff00;
                }
                .difficulty {
                    display: inline-block;
                    padding: 5px 15px;
                    border-radius: 3px;
                    font-weight: bold;
                    background-color: #ff0000;
                    color: #fff;
                }
                .warning {
                    background-color: #330000;
                    border-left: 4px solid #ff0000;
                    padding: 15px;
                    margin: 15px 0;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üëë LAB 3: PRIVILEGE ESCALATION <span class="difficulty">HARD</span></h1>
                
                <div class="info-box">
                    <h2>üìã Mission Brief</h2>
                    <p><strong>Stage:</strong> Maintained Access</p>
                    <p><strong>Objective:</strong> Gain administrative access</p>
                    <p><strong>Current User:</strong> Bob (ID: ${CURRENT_USER_ID}, Role: user)</p>
                    <p><strong>Flag:</strong> Will be revealed when you access the admin panel</p>
                </div>

                <div class="info-box">
                    <h2>üéØ Challenge Description</h2>
                    <p>The application has an admin panel that should only be accessible to administrators. Regular users like Bob should receive a "Forbidden" error.</p>
                    <p>You are logged in as Bob, a regular user. Can you find a way to access the admin panel and escalate your privileges?</p>
                </div>

                <div class="warning">
                    <strong>‚ö†Ô∏è WARNING:</strong> This is a privilege escalation challenge. You need to think about how the application determines who is an administrator.
                </div>

                <div class="endpoint">
                    <strong>API Endpoint:</strong><br>
                    <code>GET http://localhost:3001/api/lab3/user/:id/admin</code><br><br>
                    <strong>Example (will fail for you):</strong><br>
                    <code>GET http://localhost:3001/api/lab3/user/${CURRENT_USER_ID}/admin</code>
                </div>

                <div class="hint-box">
                    <strong>üí° Hints:</strong>
                    <ul>
                        <li>The endpoint checks your role, but WHERE does it get that role from?</li>
                        <li>You know from Lab 1 that there are 4 users in the system</li>
                        <li>One of these users might have admin privileges...</li>
                        <li>Can you access the admin panel by pretending to be someone else?</li>
                        <li>Think IDOR, but for privilege escalation</li>
                    </ul>
                </div>

                <div class="info-box">
                    <h2>üõ†Ô∏è Testing Instructions</h2>
                    <p><strong>Using curl:</strong></p>
                    <pre><code>curl http://localhost:3001/api/lab3/user/2/admin  # Your attempt (will fail)
curl http://localhost:3001/api/lab3/user/1/admin  # Try other users?
# Keep testing different user IDs...</code></pre>
                    
                    <p><strong>Using Browser Console (F12):</strong></p>
                    <pre><code>fetch('http://localhost:3001/api/lab3/user/4/admin')
    .then(r => r.json())
    .then(data => console.log(data));</code></pre>
                </div>

                <div style="text-align: center; margin-top: 40px;">
                    <a href="/">‚Üê Back to Home</a>
                </div>
            </div>
        </body>
        </html>
    `);
});

// Lab 3 API - Admin panel endpoint (vulnerable to privilege escalation via IDOR)
app.get('/api/lab3/user/:id/admin', (req, res) => {
    const userId = parseInt(req.params.id);
    const user = users.find(u => u.id === userId);
    
    if (!user) {
        return res.status(404).json({ error: 'User not found' });
    }
    
    // Vulnerable: Checks the role of the requested user ID, not the current user
    // Should check: if (CURRENT_USER.role !== 'admin')
    // Instead checks: if (user.role !== 'admin') where user is from URL parameter
    
    if (user.role !== 'admin') {
        return res.status(403).json({ 
            error: 'Forbidden',
            message: 'Access denied. Admin privileges required.'
        });
    }
    
    // If we get here, the user found via ID is an admin
    const isActuallyAdmin = (userId === 4); // User ID 4 is the real admin
    
    if (isActuallyAdmin && userId !== CURRENT_USER_ID) {
        return res.json({
            message: 'Welcome to the Admin Panel',
            user: user.username,
            role: user.role,
            flag: 'NSA{R00T_4CC3SS_4CH13V3D}',
            adminData: {
                totalUsers: users.length,
                systemVersion: '1.0.0',
                secretKey: 'admin_secret_key_12345'
            },
            congratulations: 'You successfully escalated privileges to admin through IDOR!'
        });
    }
    
    return res.json({
        message: 'Welcome to the Admin Panel',
        user: user.username,
        role: user.role,
        adminData: {
            totalUsers: users.length,
            systemVersion: '1.0.0'
        }
    });
});

app.listen(PORT, () => {
    console.log(`\x1b[32m
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   A01: BROKEN ACCESS CONTROL LAB          ‚ïë
‚ïë   Server running on port ${PORT}           ‚ïë
‚ïë                                            ‚ïë
‚ïë   Access the lab:                         ‚ïë
‚ïë   http://localhost:${PORT}                    ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
\x1b[0m`);
});
