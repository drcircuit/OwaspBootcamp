<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= category %> - NotSoAnonymous Portal</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">üé≠</span>
                    <h1>NOTSO<span style="color: var(--neon-pink);">ANONYMOUS</span></h1>
                </div>
                
                <div class="target-info">
                    <span class="target-label">TARGET:</span>
                    <span class="target-name">Evil Capitalistic Corp</span>
                </div>
                
                <nav>
                    <a href="/dashboard">Dashboard</a>
                    <a href="/logout">Logout</a>
                </nav>
            </div>
        </header>
        
        <main>
            <!-- Topic Header -->
            <div class="hero">
                <h1>üîí OWASP <%= category %></h1>
                <p style="font-size: 1.1rem; color: var(--neon-blue);">
                    <% if (category === 'A01') { %>
                        Understanding ‚Üí Enumeration ‚Üí Exploitation ‚Üí Escalation
                    <% } else if (category === 'A02') { %>
                        Discovery ‚Üí Analysis ‚Üí Exploitation ‚Üí Access
                    <% } else if (category === 'A03') { %>
                        Discovery ‚Üí Scanning ‚Üí Identification ‚Üí Exploitation
                    <% } else if (category === 'A04') { %>
                        Discovery ‚Üí Analysis ‚Üí Cracking ‚Üí Extraction
                    <% } else if (category === 'A05') { %>
                        Discovery ‚Üí Testing ‚Üí Exploitation ‚Üí Extraction
                    <% } else if (category === 'A06') { %>
                        Analysis ‚Üí Identification ‚Üí Testing ‚Üí Exploitation
                    <% } else if (category === 'A07') { %>
                        Analysis ‚Üí Testing ‚Üí Prediction ‚Üí Hijacking
                    <% } else if (category === 'A08') { %>
                        Discovery ‚Üí Analysis ‚Üí Manipulation ‚Üí Exploitation
                    <% } else if (category === 'A09') { %>
                        Discovery ‚Üí Analysis ‚Üí Exploitation ‚Üí Evasion
                    <% } else if (category === 'A10') { %>
                        Triggering ‚Üí Analysis ‚Üí Extraction ‚Üí Exploitation
                    <% } else { %>
                        Complete the example walkthrough, then tackle the 3 progressive labs
                    <% } %>
                </p>
                <p style="margin-top: 15px;">
                    <a href="/dashboard" class="btn">‚Üê Back to Mission Control</a>
                </p>
            </div>
            
            <!-- Alert container for dynamic messages -->
            <div id="alert-container"></div>
            
            <!-- Challenges organized by type -->
            <section>
                <% 
                const examples = challenges.filter(c => c.challenge_type === 'example');
                const labs = challenges.filter(c => c.challenge_type === 'lab').sort((a, b) => (a.lab_number || 0) - (b.lab_number || 0));
                const exams = challenges.filter(c => c.challenge_type === 'exam');
                %>
                
                 <!-- Example Section -->
                <% if (examples.length > 0) { %>
                <div style="margin-bottom: 40px;">
                    <h2 style="font-family: 'Orbitron', monospace; color: var(--neon-blue); margin-bottom: 20px;">
                        üìñ EXAMPLE / WALKTHROUGH (<%= examples.length %> Parts)
                    </h2>
                    <p style="color: var(--terminal-green); margin-bottom: 20px;">
                        Start here! Complete all <%= examples.length %> parts of the example to learn every tool and technique needed for the labs.
                        <br>
                        Each part teaches a specific tool: Browser DevTools, cURL, Burp Suite, and more.
                    </p>
                    <div class="challenges-list">
                        <% examples.forEach(challenge => { %>
                            <div class="challenge-card <%= challenge.completed ? 'completed' : '' %>">
                                <div class="challenge-header">
                                    <div>
                                        <h3 class="challenge-title">
                                            <%= challenge.completed ? '‚úì ' : '' %><%= challenge.title %>
                                        </h3>
                                        <p style="font-size: 0.85rem; color: var(--neon-blue); margin-top: 5px;">
                                            üìñ Example/Walkthrough
                                        </p>
                                    </div>
                                    <div class="challenge-meta">
                                        <span class="difficulty Tutorial">Tutorial</span>
                                        <span class="points"><%= challenge.points %> pts</span>
                                    </div>
                                </div>
                                
                                <p class="challenge-description"><%= challenge.description %></p>
                                
                                <% if (challenge.lab_url) { %>
                                    <p style="margin: 15px 0;">
                                        <strong style="color: var(--terminal-green);">Target:</strong>
                                        <a href="<%= challenge.lab_url %>" target="_blank" 
                                           style="color: var(--neon-pink); text-decoration: underline;">
                                            <%= challenge.lab_url %>
                                        </a>
                                    </p>
                                <% } %>
                                
                                <% if (challenge.tutorial) { %>
                                    <details class="accordion-drawer" style="margin: 15px 0;">
                                        <summary style="cursor: pointer; user-select: none; color: var(--neon-blue); font-weight: 600; padding: 10px; background: rgba(0, 212, 255, 0.1); border-radius: 5px; border-left: 3px solid var(--neon-blue);">
                                            üìö Show Step-by-Step Tutorial
                                        </summary>
                                        <div style="margin-top: 10px; padding: 15px; background: rgba(0, 212, 255, 0.05); border-left: 3px solid var(--neon-blue); border-radius: 4px; line-height: 1.8; white-space: pre-wrap;"><%- challenge.tutorial %></div>
                                    </details>
                                <% } %>
                                
                                <div class="challenge-actions">
                                    <% if (challenge.completed) { %>
                                        <span class="completed-badge">
                                            ‚úì COMPLETED on <%= new Date(challenge.completed_at).toLocaleDateString() %>
                                        </span>
                                    <% } else { %>
                                        <input type="text" 
                                               class="flag-input" 
                                               id="flag-<%= challenge.id %>"
                                               placeholder="Enter flag (e.g., NSA{...})"
                                               autocomplete="off">
                                        <button class="btn" onclick="submitFlag(<%= challenge.id %>)">
                                            Submit Flag
                                        </button>
                                    <% } %>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                </div>
                <% } %>
                
                <!-- Labs Section -->
                <% if (labs.length > 0) { %>
                <div style="margin-bottom: 40px;">
                    <h2 style="font-family: 'Orbitron', monospace; color: var(--neon-blue); margin-bottom: 20px;">
                        üß™ PROGRESSIVE LABS
                    </h2>
                    <p style="color: var(--terminal-green); margin-bottom: 20px;">
                        Apply what you learned! Complete labs in order for the best learning experience.
                    </p>
                    <div class="challenges-list">
                        <% labs.forEach(challenge => { %>
                            <div class="challenge-card <%= challenge.completed ? 'completed' : '' %>">
                                <div class="challenge-header">
                                    <div>
                                        <h3 class="challenge-title">
                                            <%= challenge.completed ? '‚úì ' : '' %><%= challenge.title %>
                                        </h3>
                                        <p style="font-size: 0.85rem; color: var(--neon-blue); margin-top: 5px;">
                                            <% if (challenge.challenge_type === 'example') { %>
                                                üìñ Example/Walkthrough
                                            <% } else if (challenge.lab_number) { %>
                                                üß™ Lab <%= challenge.lab_number %> - <%= challenge.difficulty %>
                                            <% } %>
                                        </p>
                                    </div>
                                    <div class="challenge-meta">
                                        <span class="difficulty <%= challenge.difficulty %>"><%= challenge.difficulty %></span>
                                        <span class="points"><%= challenge.points %> pts</span>
                                    </div>
                                </div>
                                
                                <p class="challenge-description"><%= challenge.description %></p>
                                
                                <% if (challenge.lab_url) { %>
                                    <p style="margin: 15px 0;">
                                        <strong style="color: var(--terminal-green);">Target:</strong>
                                        <a href="<%= challenge.lab_url %>" target="_blank" 
                                           style="color: var(--neon-pink); text-decoration: underline;">
                                            <%= challenge.lab_url %>
                                        </a>
                                    </p>
                                <% } %>
                                
                                <% if (challenge.mission_brief) { %>
                                    <details class="accordion-drawer" style="margin: 15px 0;">
                                        <summary style="cursor: pointer; user-select: none; color: var(--neon-pink); font-weight: 600; padding: 10px; background: rgba(255, 0, 110, 0.1); border-radius: 5px; border-left: 3px solid var(--neon-pink);">
                                            üéØ Show Mission Brief
                                        </summary>
                                        <div style="margin-top: 10px; padding: 15px; background: rgba(255, 0, 110, 0.05); border-left: 3px solid var(--neon-pink); border-radius: 4px; line-height: 1.8; white-space: pre-wrap;"><%- challenge.mission_brief %></div>
                                    </details>
                                <% } %>
                                
                                <% if (challenge.hint) { %>
                                    <details style="margin: 15px 0; color: var(--neon-blue);">
                                        <summary style="cursor: pointer; user-select: none;">üí° Show Hint</summary>
                                        <p style="margin-top: 10px; padding: 10px; background: rgba(0, 212, 255, 0.1); border-left: 3px solid var(--neon-blue); border-radius: 4px;">
                                            <%= challenge.hint %>
                                        </p>
                                    </details>
                                <% } %>
                                
                                <div class="challenge-actions">
                                    <% if (challenge.completed) { %>
                                        <span class="completed-badge">
                                            ‚úì PWNED on <%= new Date(challenge.completed_at).toLocaleDateString() %>
                                        </span>
                                    <% } else { %>
                                        <input type="text" 
                                               class="flag-input" 
                                               id="flag-<%= challenge.id %>"
                                               placeholder="Enter flag (e.g., NSA{...})"
                                               autocomplete="off">
                                        <button class="btn" onclick="submitFlag(<%= challenge.id %>)">
                                            Submit Flag
                                        </button>
                                    <% } %>
                                    
                                    <% if (challenge.attempts > 0 && !challenge.completed) { %>
                                        <span style="color: var(--warning-red); font-size: 0.85rem;">
                                            Attempts: <%= challenge.attempts %>
                                        </span>
                                    <% } %>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                </div>
                <% } %>
                
                <!-- Exam Section -->
                <% if (exams.length > 0) { %>
                <div style="margin-bottom: 40px;">
                    <h2 style="font-family: 'Orbitron', monospace; color: var(--warning-red); margin-bottom: 20px;">
                        üéì FINAL EXAM
                    </h2>
                    <p style="color: var(--warning-red); margin-bottom: 20px;">
                        The ultimate test - realistic vulnerabilities with no hints!
                    </p>
                    <div class="challenges-list">
                        <% exams.forEach(challenge => { %>
                            <div class="challenge-card <%= challenge.completed ? 'completed' : '' %>" style="border-color: var(--warning-red);">
                                <div class="challenge-header">
                                    <div>
                                        <h3 class="challenge-title">
                                            <%= challenge.completed ? '‚úì ' : '' %><%= challenge.title %>
                                        </h3>
                                    </div>
                                    <div class="challenge-meta">
                                        <span class="difficulty Expert">Expert</span>
                                        <span class="points"><%= challenge.points %> pts</span>
                                    </div>
                                </div>
                                
                                <p class="challenge-description"><%= challenge.description %></p>
                                
                                <% if (challenge.lab_url) { %>
                                    <p style="margin: 15px 0;">
                                        <strong style="color: var(--terminal-green);">Target:</strong>
                                        <a href="<%= challenge.lab_url %>" target="_blank" 
                                           style="color: var(--neon-pink); text-decoration: underline;">
                                            <%= challenge.lab_url %>
                                        </a>
                                    </p>
                                <% } %>
                                
                                <% if (challenge.mission_brief) { %>
                                    <details class="accordion-drawer" style="margin: 15px 0;">
                                        <summary style="cursor: pointer; user-select: none; color: var(--warning-red); font-weight: 600; padding: 10px; background: rgba(255, 0, 64, 0.1); border-radius: 5px; border-left: 3px solid var(--warning-red);">
                                            üéØ Show Mission Brief
                                        </summary>
                                        <div style="margin-top: 10px; padding: 15px; background: rgba(255, 0, 64, 0.05); border-left: 3px solid var(--warning-red); border-radius: 4px; line-height: 1.8; white-space: pre-wrap;"><%- challenge.mission_brief %></div>
                                    </details>
                                <% } %>
                                
                                <div class="challenge-actions">
                                    <% if (challenge.completed) { %>
                                        <span class="completed-badge">
                                            ‚úì PWNED on <%= new Date(challenge.completed_at).toLocaleDateString() %>
                                        </span>
                                    <% } else { %>
                                        <input type="text" 
                                               class="flag-input" 
                                               id="flag-<%= challenge.id %>"
                                               placeholder="Enter flag (e.g., NSA{...})"
                                               autocomplete="off">
                                        <button class="btn" onclick="submitFlag(<%= challenge.id %>)">
                                            Submit Flag
                                        </button>
                                    <% } %>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                </div>
                <% } %>
            </section>
            
            <div class="mt-3 text-center" style="padding: 30px; background: rgba(0, 255, 65, 0.05); border: 2px solid var(--terminal-green); border-radius: 8px;">
                <h3 style="color: var(--terminal-green); font-family: 'Orbitron', monospace; margin-bottom: 10px;">
                    üõ†Ô∏è TOOLS YOU'LL NEED
                </h3>
                <p style="color: var(--neon-blue);">
                    Browser DevTools (F12) ‚Ä¢ Burp Suite ‚Ä¢ curl ‚Ä¢ sqlmap ‚Ä¢ nmap ‚Ä¢ Postman
                </p>
            </div>
        </main>
        
        <footer>
            <p>üé≠ NotSoAnonymous Collective - Pwning Evil Capitalistic Corp</p>
        </footer>
    </div>
    
    <script>
        async function submitFlag(challengeId) {
            const flagInput = document.getElementById('flag-' + challengeId);
            const flag = flagInput.value.trim();
            
            if (!flag) {
                showAlert('Please enter a flag', 'error');
                return;
            }
            
            try {
                const response = await fetch('/submit-flag', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        challenge_id: challengeId,
                        flag: flag
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message, 'success');
                    
                    // Reload page after a short delay to show updated state
                    setTimeout(() => {
                        if (result.allCompleted) {
                            window.location.href = '/victory';
                        } else {
                            window.location.reload();
                        }
                    }, 1500);
                } else {
                    showAlert(result.message, 'error');
                    flagInput.value = '';
                    flagInput.focus();
                }
            } catch (error) {
                showAlert('Error submitting flag', 'error');
            }
        }
        
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = 'alert alert-' + type;
            alert.textContent = message;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        // Allow Enter key to submit flag
        document.querySelectorAll('.flag-input').forEach(input => {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const challengeId = input.id.replace('flag-', '');
                    submitFlag(challengeId);
                }
            });
        });
    </script>
</body>
</html>
