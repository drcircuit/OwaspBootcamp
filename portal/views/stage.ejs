<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= stage.stage_name %> - NotSoAnonymous Portal</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">üé≠</span>
                    <h1>NOTSO<span style="color: var(--neon-pink);">ANONYMOUS</span></h1>
                </div>
                
                <div class="target-info">
                    <span class="target-label">TARGET:</span>
                    <span class="target-name">Evil Capitalistic Corp</span>
                </div>
                
                <nav>
                    <a href="/dashboard">Dashboard</a>
                    <a href="/logout">Logout</a>
                </nav>
            </div>
        </header>
        
        <main>
            <!-- Stage Header -->
            <div class="hero">
                <h1><%= stage.icon %> <%= stage.stage_name.toUpperCase() %></h1>
                <p style="font-size: 1.1rem; color: var(--neon-blue);"><%= stage.description %></p>
                <p style="margin-top: 15px;">
                    <a href="/dashboard" class="btn">‚Üê Back to Mission Control</a>
                </p>
            </div>
            
            <!-- Alert container for dynamic messages -->
            <div id="alert-container"></div>
            
            <!-- Challenges List -->
            <section>
                <h2 style="font-family: 'Orbitron', monospace; color: var(--neon-blue); margin-bottom: 25px;">
                    üéØ CHALLENGES
                </h2>
                
                <div class="challenges-list">
                    <% challenges.forEach(challenge => { %>
                        <div class="challenge-card <%= challenge.completed ? 'completed' : '' %>">
                            <div class="challenge-header">
                                <div>
                                    <h3 class="challenge-title">
                                        <%= challenge.completed ? '‚úì ' : '' %><%= challenge.title %>
                                    </h3>
                                    <p style="font-size: 0.85rem; color: var(--neon-blue); margin-top: 5px;">
                                        OWASP <%= challenge.owasp_category %>
                                    </p>
                                </div>
                                <div class="challenge-meta">
                                    <span class="difficulty <%= challenge.difficulty %>"><%= challenge.difficulty %></span>
                                    <span class="points"><%= challenge.points %> pts</span>
                                </div>
                            </div>
                            
                            <p class="challenge-description"><%= challenge.description %></p>
                            
                            <% if (challenge.lab_url) { %>
                                <p style="margin: 15px 0;">
                                    <strong style="color: var(--terminal-green);">Target:</strong>
                                    <a href="<%= challenge.lab_url %>" target="_blank" 
                                       style="color: var(--neon-pink); text-decoration: underline;">
                                        <%= challenge.lab_url %>
                                    </a>
                                </p>
                            <% } %>
                            
                            <% if (!challenge.completed) { %>
                                <details style="margin: 15px 0; color: var(--neon-blue);">
                                    <summary style="cursor: pointer; user-select: none;">üí° Show Hint</summary>
                                    <p style="margin-top: 10px; padding: 10px; background: rgba(0, 212, 255, 0.1); border-left: 3px solid var(--neon-blue); border-radius: 4px;">
                                        <%= challenge.hint %>
                                    </p>
                                </details>
                            <% } %>
                            
                            <div class="challenge-actions">
                                <% if (challenge.completed) { %>
                                    <span class="completed-badge">
                                        ‚úì PWNED on <%= new Date(challenge.completed_at).toLocaleDateString() %>
                                    </span>
                                <% } else { %>
                                    <input type="text" 
                                           class="flag-input" 
                                           id="flag-<%= challenge.id %>"
                                           placeholder="Enter flag (e.g., NSA{...})"
                                           autocomplete="off">
                                    <button class="btn" onclick="submitFlag(<%= challenge.id %>)">
                                        Submit Flag
                                    </button>
                                <% } %>
                                
                                <% if (challenge.attempts > 0 && !challenge.completed) { %>
                                    <span style="color: var(--warning-red); font-size: 0.85rem;">
                                        Attempts: <%= challenge.attempts %>
                                    </span>
                                <% } %>
                            </div>
                        </div>
                    <% }) %>
                </div>
            </section>
            
            <div class="mt-3 text-center" style="padding: 30px; background: rgba(0, 255, 65, 0.05); border: 2px solid var(--terminal-green); border-radius: 8px;">
                <h3 style="color: var(--terminal-green); font-family: 'Orbitron', monospace; margin-bottom: 10px;">
                    üõ†Ô∏è TOOLS YOU'LL NEED
                </h3>
                <p style="color: var(--neon-blue);">
                    Browser DevTools (F12) ‚Ä¢ Burp Suite ‚Ä¢ curl ‚Ä¢ sqlmap ‚Ä¢ nmap ‚Ä¢ Postman
                </p>
            </div>
        </main>
        
        <footer>
            <p>üé≠ NotSoAnonymous Collective - Pwning Evil Capitalistic Corp</p>
        </footer>
    </div>
    
    <script>
        async function submitFlag(challengeId) {
            const flagInput = document.getElementById('flag-' + challengeId);
            const flag = flagInput.value.trim();
            
            if (!flag) {
                showAlert('Please enter a flag', 'error');
                return;
            }
            
            try {
                const response = await fetch('/submit-flag', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        challenge_id: challengeId,
                        flag: flag
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message, 'success');
                    
                    // Reload page after a short delay to show updated state
                    setTimeout(() => {
                        if (result.allCompleted) {
                            window.location.href = '/victory';
                        } else {
                            window.location.reload();
                        }
                    }, 1500);
                } else {
                    showAlert(result.message, 'error');
                    flagInput.value = '';
                    flagInput.focus();
                }
            } catch (error) {
                showAlert('Error submitting flag', 'error');
            }
        }
        
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = 'alert alert-' + type;
            alert.textContent = message;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        // Allow Enter key to submit flag
        document.querySelectorAll('.flag-input').forEach(input => {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const challengeId = input.id.replace('flag-', '');
                    submitFlag(challengeId);
                }
            });
        });
    </script>
</body>
</html>
